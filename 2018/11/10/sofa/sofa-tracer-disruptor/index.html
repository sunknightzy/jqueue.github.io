<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta />
    <title>SOFATracer 中 Disruptor 实践 - J.Queue的技术博客</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="application-name" content="J.Queue的技术博客" />
    <meta name="msapplication-TileImage" content="/img/favicon.ico" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="J.Queue的技术博客" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta
      name="description"
      content="OpenTraceing 规范 OpenTracing语义标准 语义惯例 官方文档"
    />
    <meta property="og:type" content="blog" />
    <meta property="og:title" content="SOFATracer 中 Disruptor 实践" />
    <meta
      property="og:url"
      content="http://sunknightzy.github.io/2018/11/10/sofa/sofa-tracer-disruptor/"
    />
    <meta property="og:site_name" content="J.Queue的技术博客" />
    <meta
      property="og:description"
      content="OpenTraceing 规范 OpenTracing语义标准 语义惯例 官方文档"
    />
    <meta property="og:locale" content="zh_CN" />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/16504080427c32c5~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165040897c8cd0fd~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165040ee8a2eae73~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/1650414723061ce7~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/1650415d0682db8f~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165041aeac0dc066~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="og:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165041c4514a3102~tplv-t2oaga2asx-image.image"
    />
    <meta
      property="article:published_time"
      content="2018-11-10T04:26:20.000Z"
    />
    <meta property="article:modified_time" content="2022-04-23T11:30:08.483Z" />
    <meta property="article:author" content="J.Queue" />
    <meta property="article:tag" content="Tracer" />
    <meta property="article:tag" content="分布式链路跟踪" />
    <meta property="article:tag" content="Disruptor" />
    <meta property="twitter:card" content="summary" />
    <meta
      property="twitter:image"
      content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/16504080427c32c5~tplv-t2oaga2asx-image.image"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "http://sunknightzy.github.io/2018/11/10/sofa/sofa-tracer-disruptor/"
        },
        "headline": "SOFATracer 中 Disruptor 实践",
        "image": [],
        "datePublished": "2018-11-10T04:26:20.000Z",
        "dateModified": "2022-04-23T11:30:08.483Z",
        "author": { "@type": "Person", "name": "J.Queue" },
        "publisher": {
          "@type": "Organization",
          "name": "J.Queue的技术博客",
          "logo": {
            "@type": "ImageObject",
            "url": { "text": "J.Queue的技术博客" }
          }
        },
        "description": "OpenTraceing 规范 OpenTracing语义标准 语义惯例 官方文档"
      }
    </script>
    <link
      rel="canonical"
      href="http://sunknightzy.github.io/2018/11/10/sofa/sofa-tracer-disruptor/"
    />
    <link rel="icon" href="/img/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/github.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"
    />
    <link rel="stylesheet" href="/css/default.css" />
    <style>
      body > .footer,
      body > .navbar,
      body > .section {
        opacity: 0;
      }
    </style>
    <!--!-->
    <!--!-->
    <!--!-->
    <script
      src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
      defer
    ></script>
    <!--!-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"
    />
    <!--!-->
    <!--!-->
    <style>
      .pace {
        -webkit-pointer-events: none;
        pointer-events: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }
      .pace-inactive {
        display: none;
      }
      .pace .pace-progress {
        background: #3273dc;
        position: fixed;
        z-index: 2000;
        top: 0;
        right: 100%;
        width: 100%;
        height: 2px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script>
    <!--!-->
    <!--!-->
    <!-- hexo injector head_end start -->
    <script>
      ;(function () {
        function switchTab() {
          if (!location.hash) {
            return
          }
          Array.from(document.querySelectorAll('.tab-content')).forEach(
            ($tab) => {
              $tab.classList.add('is-hidden')
            }
          )
          Array.from(document.querySelectorAll('.tabs li')).forEach(($tab) => {
            $tab.classList.remove('is-active')
          })
          const $activeTab = document.querySelector(location.hash)
          if ($activeTab) {
            $activeTab.classList.remove('is-hidden')
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`)
          if ($tabMenu) {
            $tabMenu.parentElement.classList.add('is-active')
          }
        }
        switchTab()
        window.addEventListener('hashchange', switchTab, false)
      })()
    </script>
    <!-- hexo injector head_end end -->
    <meta name="generator" content="Hexo 6.1.0" />
    <link
      rel="alternate"
      href="/atom.xml"
      title="J.Queue的技术博客"
      type="application/atom+xml"
    />
  </head>
  <body class="is-3-column">
    <nav class="navbar navbar-main">
      <div class="container navbar-container">
        <div class="navbar-brand justify-content-center">
          <a class="navbar-item navbar-logo" href="/">J.Queue的技术博客</a>
        </div>
        <div class="navbar-menu">
          <div class="navbar-start">
            <a class="navbar-item" href="/">首页</a
            ><a class="navbar-item" href="/archives">归档</a
            ><a class="navbar-item" href="/categories">分类</a
            ><a class="navbar-item" href="/tags">Tags</a
            ><a class="navbar-item" href="/about">关于</a>
          </div>
          <div class="navbar-end">
            <a
              class="navbar-item"
              target="_blank"
              rel="noopener"
              title="Download on GitHub"
              href="https://github.com/glmapper"
              ><i class="fab fa-github"></i></a
            ><a
              class="navbar-item is-hidden-tablet catalogue"
              title="目录"
              href="javascript:;"
              ><i class="fas fa-list-ul"></i></a
            ><a class="navbar-item search" title="搜索" href="javascript:;"
              ><i class="fas fa-search"></i
            ></a>
          </div>
        </div>
      </div>
    </nav>
    <section class="section">
      <div class="container">
        <div class="columns">
          <div
            class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"
          >
            <div class="card">
              <article class="card-content article" role="article">
                <div
                  class="article-meta is-size-7 is-uppercase level is-mobile"
                >
                  <div class="level-left">
                    <span class="level-item"
                      ><time
                        datetime="2018-11-10T04:26:20.000Z"
                        title="2018/11/10 下午12:26:20"
                        >2018-11-10</time
                      >发表</span
                    ><span class="level-item"
                      ><time
                        datetime="2022-04-23T11:30:08.483Z"
                        title="2022/4/23 下午7:30:08"
                        >2022-04-23</time
                      >更新</span
                    ><span class="level-item"
                      ><a class="link-muted" href="/categories/SOFA/"
                        >SOFA</a
                      ></span
                    ><span class="level-item">44 分钟读完 (大约6595个字)</span
                    ><span class="level-item" id="busuanzi_container_page_pv"
                      ><span id="busuanzi_value_page_pv">0</span>次访问</span
                    >
                  </div>
                </div>
                <h1 class="title is-3 is-size-4-mobile">
                  SOFATracer 中 Disruptor 实践
                </h1>
                <div class="content">
                  <h2 id="OpenTraceing-规范">
                    <a
                      href="#OpenTraceing-规范"
                      class="headerlink"
                      title="OpenTraceing 规范"
                    ></a
                    >OpenTraceing 规范
                  </h2>
                  <ul>
                    <li>
                      <a
                        target="_blank"
                        rel="noopener"
                        href="https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md"
                        >OpenTracing语义标准</a
                      >
                    </li>
                    <li>
                      <a
                        target="_blank"
                        rel="noopener"
                        href="https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md"
                        >语义惯例</a
                      >
                    </li>
                    <li>
                      <a
                        target="_blank"
                        rel="noopener"
                        href="http://opentracing.io/documentation/pages/spec"
                        >官方文档</a
                      >
                    </li>
                  </ul>
                  <span id="more"></span>

                  <h2 id="SOFATracer-对-OpenTraceing-的实现">
                    <a
                      href="#SOFATracer-对-OpenTraceing-的实现"
                      class="headerlink"
                      title="SOFATracer 对 OpenTraceing 的实现"
                    ></a
                    >SOFATracer 对 OpenTraceing 的实现
                  </h2>
                  <blockquote>
                    <p>
                      SOFATracer 就是根据 OpenTracing 规范 衍生出来的分布式
                      链路跟 踪的解决方案。
                    </p>
                  </blockquote>
                  <ul>
                    <li>
                      <a
                        target="_blank"
                        rel="noopener"
                        href="https://github.com/alipay/sofa-tracer"
                        >GitHub SOFATrcer</a
                      >
                    </li>
                  </ul>
                  <h3 id="概念">
                    <a href="#概念" class="headerlink" title="概念"></a>概念
                  </h3>
                  <p>
                    <code>OpenTracing</code>
                    标准中有三个重要的相互关联的类型，分别是<code>Tracer</code>,
                    <code>Span</code>和 <code>SpanContext</code>。
                  </p>
                  <blockquote>
                    <p>
                      【下面的概念说明过程中，如不做说明，所使用的案例代码均以SOFATracer中的实现为例。】
                    </p>
                  </blockquote>
                  <h3 id="Tracer">
                    <a href="#Tracer" class="headerlink" title="Tracer"></a
                    >Tracer
                  </h3>
                  <p>
                    一个
                    <code>trace</code>
                    代表一个潜在的，分布式的，存在并行数据或并行执行轨迹（潜在的分布式、并行）的系统。一个<code>trace</code>可以认为是多个<code>span</code>的有向无环图（<code>DAG</code>）。
                  </p>
                  <p>
                    Tracer接口用来创建Span，以及处理如何处理Inject(serialize)
                    和 Extract (deserialize)，用于跨进程边界传递。
                  </p>
                  <p>
                    <code>SOFATracer</code> 中
                    <code>SofaTracer </code>这个类实现了
                    <code>opentracing</code> 的
                    <code>Tracer</code>
                    接口，并在此规范接口上做了一些扩展。看下<code>Tracer</code>
                    中声明的方法：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Tracer</span> &#123;</span><br><span class="line">    <span class="comment">//启动一个新的span</span></span><br><span class="line">    SpanBuilder <span class="title function_">buildSpan</span><span class="params">(String operationName)</span>;</span><br><span class="line">    <span class="comment">//将SpanContext上下文Inject（注入）到carrier</span></span><br><span class="line">    &lt;C&gt; <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(SpanContext spanContext, Format&lt;C&gt; format, C carrier)</span>;</span><br><span class="line">    <span class="comment">//将SpanContext上下文从carrier中Extract（提取）</span></span><br><span class="line">    &lt;C&gt; SpanContext <span class="title function_">extract</span><span class="params">(Format&lt;C&gt; format, C carrier)</span>;   </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">SpanBuilder</span> &#123;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    所以从接口定义来看，要实现一个Tracer，必须要实现其以下的几个能力：
                  </p>
                  <h4 id="启动一个新的span">
                    <a
                      href="#启动一个新的span"
                      class="headerlink"
                      title="启动一个新的span"
                    ></a
                    >启动一个新的span
                  </h4>
                  <p>
                    <code>SOFATracer</code> 实现了 <code>Tracer</code> 中
                    <code>buildSpan</code> 方法：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SpanBuilder <span class="title function_">buildSpan</span><span class="params">(String operationName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SofaTracerSpanBuilder</span>(operationName);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <code>operationName</code>
                    :操作名称，字符串类型，表示由Span完成的工作
                    (例如，RPC方法名称、函数名称或一个较大的计算任务中的阶段的名称)。操作名称应该用泛化的字符串形式标识出一个Span实例。
                  </p>
                  <p>
                    何为泛化的字符串形式，比如现在有一个操作：获取用户
                    ；下面有几种标识方式：
                  </p>
                  <ul>
                    <li>1、&#x2F;get</li>
                    <li>2、&#x2F;get&#x2F;user</li>
                    <li>3、&#x2F;get&#x2F;user&#x2F;123</li>
                  </ul>
                  <p>方式1过于抽象，方式3过于具体。方式2是正确的操作名。</p>
                  <h4 id="将SpanContext上下文Inject（注入）到carrier">
                    <a
                      href="#将SpanContext上下文Inject（注入）到carrier"
                      class="headerlink"
                      title="将SpanContext上下文Inject（注入）到carrier"
                    ></a
                    >将SpanContext上下文Inject（注入）到carrier
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;C&gt; <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(SpanContext spanContext, Format&lt;C&gt; format, C carrier)</span> &#123;</span><br><span class="line">    RegistryExtractorInjector&lt;C&gt; registryInjector = TracerFormatRegistry.getRegistry(format);</span><br><span class="line">    <span class="keyword">if</span> (registryInjector == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported injector format: &quot;</span> + format);</span><br><span class="line">    &#125;</span><br><span class="line">    registryInjector.inject((SofaTracerSpanContext) spanContext, carrier);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li><code>SpanContext</code> :实例</li>
                    <li>
                      <code>format</code
                      >（格式化）描述，一般会是一个字符串常量，但不做强制要求。通过此描述，通知Tracer实现，如何对SpanContext进行编码放入到carrier中。<br />carrier，根据format确定。Tracer实现根据format声明的格式，将SpanContext序列化到carrier对象中。
                    </li>
                  </ul>
                  <blockquote>
                    <p>RegistryExtractorInjector 见后面</p>
                  </blockquote>
                  <h4 id="将SpanContext上下文从carrier中Extract（提取）">
                    <a
                      href="#将SpanContext上下文从carrier中Extract（提取）"
                      class="headerlink"
                      title="将SpanContext上下文从carrier中Extract（提取）"
                    ></a
                    >将SpanContext上下文从carrier中Extract（提取）
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;C&gt; SpanContext <span class="title function_">extract</span><span class="params">(Format&lt;C&gt; format, C carrier)</span> &#123;</span><br><span class="line">    RegistryExtractorInjector&lt;C&gt; registryExtractor = TracerFormatRegistry.getRegistry(format);</span><br><span class="line">    <span class="keyword">if</span> (registryExtractor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported extractor format: &quot;</span> + format);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> registryExtractor.extract(carrier);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      格式描述符(<code>format descriptor</code
                      >)(通常但不一定是字符串常量)，告诉<code>Tracer</code>的实现如何在载体对象中对<code>SpanContext</code>进行编码
                    </li>
                    <li>
                      载体(<code>carrier</code>)，其类型由格式描述符指定<code>。Tracer</code>的实现将根据格式描述对此载体对象中的<code>SpanContext</code>进行编码
                    </li>
                  </ul>
                  <p>
                    返回一个<code>SpanContext</code>实例，可以使用这个<code>SpanContext</code>实例，通过<code>Tracer</code>创建新的<code>Span</code>。
                  </p>
                  <h4 id="Format">
                    <a href="#Format" class="headerlink" title="Format"></a
                    >Format
                  </h4>
                  <p>
                    从<code>Tracer</code>的注入和提取来看，<code>format</code>都是必须的。
                  </p>
                  <p>
                    <code>Inject</code
                    >（注入）和<code>Extract</code>（提取）依赖于可扩展的<code>format</code>参数。<code>forma</code>t参数规定了另一个参数<code>&quot;carrier&quot;</code>的类型，同时约束了<code>&quot;carrier&quot;</code>中<code>SpanContext</code>是如何编码的。所有的<code>Tracer</code>实现，都必须支持下面的<code>format</code>。
                  </p>
                  <ul>
                    <li>
                      <code>Text Map</code>:
                      基于字符串：字符串的<code>map</code>,对于<code>key</code>和<code>value</code>不约束字符集。
                    </li>
                    <li>
                      <code>HTTP Headers</code>:
                      适合作为<code>HTTP</code>头信息的，基于字符串：字符串的<code>map</code>。（<code
                        >RFC 7230.</code
                      >在工程实践中，如何处理<code>HTTP</code>头具有多样性，强烈建议<code>tracer</code>的使用者谨慎使用<code>HTTP</code>头的键值空间和转义符）
                    </li>
                    <li>
                      <code>Binary</code>:
                      一个简单的二进制大对象，记录<code>SpanContext</code>的信息。
                    </li>
                  </ul>
                  <p>在上面的注入和提取代码中，有如下代码片段：</p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//注入</span></span><br><span class="line">RegistryExtractorInjector&lt;C&gt; registryInjector  = </span><br><span class="line">    TracerFormatRegistry.getRegistry(format);</span><br><span class="line"><span class="comment">//提取</span></span><br><span class="line">RegistryExtractorInjector&lt;C&gt; registryExtractor = </span><br><span class="line">    TracerFormatRegistry.getRegistry(format);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    来通过<code>TracerFormatRegistry</code>这个类来来看下
                    <code>SOFATracer</code> 中的
                    <code>Format</code> 的具体实现。
                  </p>
                  <h4 id="X-B3">
                    <a href="#X-B3" class="headerlink" title="X-B3"></a>X-B3
                  </h4>
                  <p>
                    在看<code>Format</code>之前，先了解下<code>X-B3</code>。
                  </p>
                  <figure class="highlight http">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">Access-Control-Expose-Headers</span><span class="punctuation">: </span></span><br><span class="line">X-B3-TraceId,X-B3-ParentSpanId,X-B3-SpanId</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <code>HTTP</code>请求时其<code>span</code>参数通过<code
                      >http headers</code
                    >来传递追踪信息；<code>header</code>中对应的<code>key</code>分别是:
                  </p>
                  <ul>
                    <li>
                      X-B3-TraceId: 64 encoded bits（id被encode为hex Strings）
                    </li>
                    <li>X-B3-SpanId : 64 encoded bits</li>
                    <li>X-B3-ParentSpanId: 64 encoded bits</li>
                    <li>
                      X-B3-Sampled:(是否采样) Boolean (either “1” or
                      “0”)（下面的调用是否进行采样）
                    </li>
                    <li>X-B3-Flags:a Long</li>
                  </ul>
                  <h4 id="SOFATracer-中的-Format">
                    <a
                      href="#SOFATracer-中的-Format"
                      class="headerlink"
                      title="SOFATracer 中的 Format"
                    ></a
                    >SOFATracer 中的 Format
                  </h4>
                  <p>
                    具体代码在
                    <code
                      >tracer-core -&gt;
                      com.alipay.common.tracer.core.registy</code
                    >
                    包下:
                  </p>
                  <ul>
                    <li>TextMapFormatter</li>
                    <li>TextMapB3Formatter</li>
                    <li>HttpHeadersFormatter</li>
                    <li>HttpHeadersB3Formatter</li>
                    <li>BinaryFormater</li>
                  </ul>
                  <p>
                    <strong>BinaryFormater</strong
                    >：这个的注入和提取实现没有编解码一说；本身就是基于二进制流的操作。
                  </p>
                  <p>
                    <strong>TextMapB3Formatter&#x2F;TextMapFormatter</strong> 和
                    <strong
                      >HttpHeadersB3Formatter&#x2F;HttpHeadersFormatter</strong
                    >
                    区别就在于编解码不同。<code>HttpHeadersB3Formatter</code>使用的是
                    <code>URLDecoder.decode</code> &amp;&amp;
                    <code>URLDecoder.encode</code> ;
                    <code>TextMapB3Formatter</code>
                    返回的是值本身（如果为空或者<code>null</code>则返回空字符串）。
                  </p>
                  <p>
                    <strong>TextMapFormatter</strong
                    >和<strong>TextMapB3Formatter</strong>区别在于注入或者提取是使用的<code>key</code>不用。<code>TextMapB3Formatter</code>中使用的是
                    <code>x-b3-&#123;&#125;</code>
                    的字符串作为<code>key</code>。
                  </p>
                  <h3 id="Span">
                    <a href="#Span" class="headerlink" title="Span"></a>Span
                  </h3>
                  <p>
                    一个<code>span</code>代表系统中具有开始时间和执行时长的逻辑运行单元。<code>span</code>之间通过嵌套或者顺序排列建立逻辑因果关系。当<code>Span</code>结束后(<code>span.finish()</code>)，除了通过<code>Span</code>获取<code>SpanContext</code>外，下列其他所有方法都不允许被调用。
                  </p>
                  <p>
                    同样先来看下<code>opentracing</code>规范<code> api</code>
                    定义的 <code>span</code> 的定义及方法：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Span</span> <span class="keyword">extends</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    SpanContext <span class="title function_">context</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">(<span class="type">long</span> finishMicros)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">    Span <span class="title function_">setTag</span><span class="params">(String key, String value)</span>;</span><br><span class="line">    Span <span class="title function_">setTag</span><span class="params">(String key, <span class="type">boolean</span> value)</span>;</span><br><span class="line">    Span <span class="title function_">setTag</span><span class="params">(String key, Number value)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(Map&lt;String, ?&gt; fields)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(<span class="type">long</span> timestampMicroseconds, Map&lt;String, ?&gt; fields)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(String event)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(<span class="type">long</span> timestampMicroseconds, String event)</span>;</span><br><span class="line">    Span <span class="title function_">setBaggageItem</span><span class="params">(String key, String value)</span>;</span><br><span class="line">    String <span class="title function_">getBaggageItem</span><span class="params">(String key)</span>;</span><br><span class="line">    Span <span class="title function_">setOperationName</span><span class="params">(String operationName)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(String eventName, <span class="comment">/* @Nullable */</span> Object payload)</span>;</span><br><span class="line">    Span <span class="title function_">log</span><span class="params">(<span class="type">long</span> timestampMicroseconds, String eventName, <span class="comment">/* @Nullable */</span> Object payload)</span>;</span><br><span class="line">&#125; </span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h4 id="通过Span获取SpanContext">
                    <a
                      href="#通过Span获取SpanContext"
                      class="headerlink"
                      title="通过Span获取SpanContext"
                    ></a
                    >通过Span获取SpanContext
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//SOFATracerSpan</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SpanContext <span class="title function_">context</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.sofaTracerSpanContext;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    返回值，<code>Span</code>构建时传入的<code>SpanContext</code>。这个返回值在<code>Span</code>结束后(<code>span.finish()</code>)，依然可以使用。
                  </p>
                  <h4 id="复写操作名">
                    <a
                      href="#复写操作名"
                      class="headerlink"
                      title="复写操作名"
                    ></a
                    >复写操作名
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Span <span class="title function_">setOperationName</span><span class="params">(String operationName)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.operationName = operationName;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <strong>operationName</strong
                    >:新的操作名，覆盖构建<code>Span</code>时，传入的操作名。
                  </p>
                  <h4 id="结束Span">
                    <a href="#结束Span" class="headerlink" title="结束Span"></a
                    >结束Span
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.finish(System.currentTimeMillis());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">(<span class="type">long</span> endTime)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setEndTime(endTime);</span><br><span class="line">    <span class="comment">//关键记录:report span</span></span><br><span class="line">    <span class="built_in">this</span>.sofaTracer.reportSpan(<span class="built_in">this</span>);</span><br><span class="line">    SpanExtensionFactory.logStoppedSpan(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    有一个可选参数，如果指定完成时间则使用当前指定的时间；如果省略此参数，使用当前时间作为完成时间。<code>finish</code>方法中会将当前<code>span</code>进行<code>report</code>操作。
                  </p>
                  <h4 id="为Span设置tag">
                    <a
                      href="#为Span设置tag"
                      class="headerlink"
                      title="为Span设置tag"
                    ></a
                    >为Span设置tag
                  </h4>
                  <p>
                    <code>Tag </code
                    >是一个<code>key:value</code>格式的数据。<code>key</code>必须是<code>String</code>类型，<code>value</code>可以是<strong>字符串、布尔或者数字</strong>。
                  </p>
                  <ul>
                    <li>字符串类型的value 设置tag</li>
                  </ul>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Span <span class="title function_">setTag</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(key) || StringUtils.isBlank(value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.tagsWithStr.put(key, value);</span><br><span class="line">    <span class="comment">//注意:server 还是 client 在 OpenTracing 标准中是用 tags 标识的,所以在这里进行判断</span></span><br><span class="line">    <span class="keyword">if</span> (isServer()) &#123;</span><br><span class="line">        <span class="type">Reporter</span> <span class="variable">serverReporter</span> <span class="operator">=</span> <span class="built_in">this</span>.sofaTracer.getServerReporter();</span><br><span class="line">        <span class="keyword">if</span> (serverReporter != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setLogType(serverReporter.getReporterType());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isClient()) &#123;</span><br><span class="line">        <span class="type">Reporter</span> <span class="variable">clientReporter</span> <span class="operator">=</span> <span class="built_in">this</span>.sofaTracer.getClientReporter();</span><br><span class="line">        <span class="keyword">if</span> (clientReporter != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setLogType(clientReporter.getReporterType());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>布尔类型的value 设置tag</li>
                  </ul>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> Span <span class="title function_">setTag</span><span class="params">(String key, <span class="type">boolean</span> value)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.tagsWithBool.put(key, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>数字类型的value 设置tag</li>
                  </ul>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> Span <span class="title function_">setTag</span><span class="params">(String key, Number number)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (number == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.tagsWithNumber.put(key, number);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h4 id="Log结构化数据">
                    <a
                      href="#Log结构化数据"
                      class="headerlink"
                      title="Log结构化数据"
                    ></a
                    >Log结构化数据
                  </h4>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Span <span class="title function_">log</span><span class="params">(<span class="type">long</span> currentTime, Map&lt;String, ?&gt; map)</span> &#123;</span><br><span class="line">    AssertUtils.isTrue(currentTime &gt;= startTime, <span class="string">&quot;current time must greater than start time&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.logs.add(<span class="keyword">new</span> <span class="title class_">LogData</span>(currentTime, map));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Span <span class="title function_">log</span><span class="params">(Map&lt;String, ?&gt; map)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.log(System.currentTimeMillis(), map);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      <strong>Map&lt;String, ?&gt; map</strong> :
                      键必须是字符串类型，值可以是任意类型
                    </li>
                    <li>
                      <strong>currentTime</strong> :
                      时间戳。如果指定时间戳，那么它必须在<code>span</code>的开始和结束时间之内。
                    </li>
                  </ul>
                  <h4 id="设置一个baggage（随行数据）元素">
                    <a
                      href="#设置一个baggage（随行数据）元素"
                      class="headerlink"
                      title="设置一个baggage（随行数据）元素"
                    ></a
                    >设置一个baggage（随行数据）元素
                  </h4>
                  <p>
                    <code>Baggage</code
                    >元素是一个键值对集合，将这些值设置给给定的<code>Span</code>，<code>Span</code>的<code>SpanContext</code>，以及所有和此<code>Span</code>有直接或者间接关系的本地<code>Span</code>。
                    也就是说，<code>baggage</code>元素随<code>trace</code>一起保持在带内传递。（译者注：带内传递，在这里指，随应用程序调用过程一起传递）
                  </p>
                  <p>
                    <code>Baggage</code
                    >元素为<code>OpenTracing</code>的实现全栈集成，提供了强大的功能
                    （例如：任意的应用程序数据，可以在移动端创建它，显然的，它会一直传递了系统最底层的存储系统。由于它如此强大的功能，他也会产生巨大的开销，请小心使用此特性。
                  </p>
                  <p>
                    再次强调，请谨慎使用此特性。每一个键值都会被拷贝到每一个本地和远程的下级相关的<code>span</code>中，因此，总体上，他会有明显的网络和<code>CPU</code>开销。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Span <span class="title function_">setBaggageItem</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sofaTracerSpanContext.setBizBaggageItem(key, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h4 id="SofaTracerSpan-中的属性">
                    <a
                      href="#SofaTracerSpan-中的属性"
                      class="headerlink"
                      title="SofaTracerSpan 中的属性"
                    ></a
                    >SofaTracerSpan 中的属性
                  </h4>
                  <ul>
                    <li>sofaTracer  : 当前 tracer</li>
                    <li>
                      spanReferences : 当前span的关系，ChildOf(引用) or
                      FollowsFrom（跟随）
                    </li>
                    <li>tagsWithStr : String 类型的tag 集合</li>
                    <li>tagsWithBool : 布尔类型的tag集合</li>
                    <li>tagsWithNumber : 数值类型的tag集合</li>
                    <li>
                      logs :
                      log结构化数据列表，通过span.log（map）操作的map,均存储在logs中。
                    </li>
                    <li>operationName：当前span的操作名</li>
                    <li>sofaTracerSpanContext：当前 spanContext</li>
                    <li>startTime : 当前span 开始时间</li>
                    <li>endTime : 当前span 结束时间，在finish方法中传入。</li>
                    <li>
                      logType :
                      report时才有意义:摘要日志类型,日志能够正确打印的关键信息；当前
                      span 的日志类型,如:客户端为 rpc-client-digest.log,服务端为
                      rpc-server-digest.log
                    </li>
                    <li>
                      parentSofaTracerSpan：父亲
                      span,当作为客户端结束并弹出线程上下文时,需要将父亲 span
                      再放入
                    </li>
                  </ul>
                  <h4 id="SpanContext">
                    <a
                      href="#SpanContext"
                      class="headerlink"
                      title="SpanContext"
                    ></a
                    >SpanContext
                  </h4>
                  <p>
                    <code>opentracing</code> 中
                    <code>SpanContext</code>
                    接口中只有一个<code>baggageItems</code>方法，通过这个方法来遍历所有的<code>baggage</code>元素。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SpanContext</span> &#123;</span><br><span class="line">    Iterable&lt;Map.Entry&lt;String, String&gt;&gt; baggageItems();</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    相对于<code>OpenTracing</code>中其他的功能，<code>SpanContext</code>更多的是一个“概念”。也就是说，<code>OpenTracing</code>实现中，需要重点考虑，并提供一套自己的<code>API</code>。
                  </p>
                  <p>
                    <code>OpenTracing</code
                    >的使用者仅仅需要，在创建<code>span</code>、向传输协议<code>Inject</code>（注入）和从传输协议中<code>Extract</code>（提取）时，使用<code>SpanContext</code>和<code>references</code>，
                  </p>
                  <p>
                    <code>OpenTracing</code
                    >要求，<code>SpanContext</code>是不可变的，目的是防止由于<code>Span</code>的结束和相互关系，造成的复杂生命周期问题。
                  </p>
                  <h2 id="Disruptor-简介">
                    <a
                      href="#Disruptor-简介"
                      class="headerlink"
                      title="Disruptor 简介"
                    ></a
                    >Disruptor 简介
                  </h2>
                  <blockquote>
                    <p>
                      A High Performance Inter-Thread Messaging Library
                      高性能的线程间消息传递库
                    </p>
                  </blockquote>
                  <p>
                    关于 Disruptor 的 一些原理分析可以参考：<a
                      target="_blank"
                      rel="noopener"
                      href="https://ifeve.com/disruptor/"
                      >disruptor</a
                    >
                  </p>
                  <h2 id="案例">
                    <a href="#案例" class="headerlink" title="案例"></a>案例
                  </h2>
                  <p>
                    先通过
                    <code>Disruptor</code>
                    的一个小例子来有个直观的认识；先看下它的构造函数：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="title function_">Disruptor</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> EventFactory&lt;T&gt; eventFactory,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> ringBufferSize,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> ProducerType producerType,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> WaitStrategy waitStrategy)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">this</span>(</span><br><span class="line">        RingBuffer.create(producerType, eventFactory, ringBufferSize, waitStrategy),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">BasicExecutor</span>(threadFactory));</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      eventFactory : 在环形缓冲区中创建事件的
                      <code>factory</code>
                    </li>
                    <li>ringBufferSize:环形缓冲区的大小，必须是2的幂。</li>
                    <li>threadFactory：用于为处理器创建线程。</li>
                    <li>
                      producerType：生成器类型以支持使用正确的<code>sequencer</code>和<code>publisher</code>创建<code>RingBuffer</code>；枚举类型，<code>SINGLE</code>、<code>MULTI</code>两个项。对应于
                      <code>SingleProducerSequencer</code
                      >和<code>MultiProducerSequencer</code>两种<code>Sequencer</code>。
                    </li>
                    <li>waitStrategy : 等待策略；</li>
                  </ul>
                  <p>
                    如果我们想构造一个<code>disruptor</code>,那么我们就需要上面的这些组件。从<code>eventFactory</code>来看，还需要一个具体的<code>Event</code>来作为消息事件的载体。【下面按照官方给的案例进行简单的修改作为示例】
                  </p>
                  <h3 id="消息事件-LongEvent-，能够被消费的数据载体">
                    <a
                      href="#消息事件-LongEvent-，能够被消费的数据载体"
                      class="headerlink"
                      title="消息事件 LongEvent ，能够被消费的数据载体"
                    ></a
                    >消息事件 LongEvent ，能够被消费的数据载体
                  </h3>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> value;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">long</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="创建消息事件的factory">
                    <a
                      href="#创建消息事件的factory"
                      class="headerlink"
                      title="创建消息事件的factory"
                    ></a
                    >创建消息事件的factory
                  </h3>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongEventFactory</span> <span class="keyword">implements</span> <span class="title class_">EventFactory</span>&lt;LongEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LongEvent <span class="title function_">newInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LongEvent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="ConsumerThreadFactory">
                    <a
                      href="#ConsumerThreadFactory"
                      class="headerlink"
                      title="ConsumerThreadFactory"
                    ></a
                    >ConsumerThreadFactory
                  </h3>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;disruptor-thread-&quot;</span> + index.getAndIncrement());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    OK ，上面的这些可以满足创建一个<code>disruptor</code>了：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">ringBufferCapacity</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"><span class="comment">//消息事件生产Factory</span></span><br><span class="line"><span class="type">LongEventFactory</span> <span class="variable">longEventFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongEventFactory</span>();</span><br><span class="line"><span class="comment">//执行事件处理器线程Factory</span></span><br><span class="line"><span class="type">ConsumerThreadFactory</span> <span class="variable">consumerThreadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConsumerThreadFactory</span>();</span><br><span class="line"><span class="comment">//用于环形缓冲区的等待策略。</span></span><br><span class="line"><span class="type">WaitStrategy</span> <span class="variable">waitStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockingWaitStrategy</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//构建disruptor</span></span><br><span class="line">Disruptor&lt;LongEvent&gt; disruptor = <span class="keyword">new</span> <span class="title class_">Disruptor</span>&lt;&gt;(</span><br><span class="line">    longEventFactory,</span><br><span class="line">    ringBufferCapacity,</span><br><span class="line">    longEventThreadFactory,</span><br><span class="line">    ProducerType.SINGLE,</span><br><span class="line">    waitStrategy);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    现在是已经有了 <code>disruptor</code> 了，然后通过：<code
                      >start</code
                    >
                    来启动：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//启动 disruptor</span></span><br><span class="line"> disruptor.start();</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    到这里，已经构建了一个<code>disruptor</code>；但是目前怎么使用它来发布消息和消费消息呢？
                  </p>
                  <h3 id="发布消息">
                    <a href="#发布消息" class="headerlink" title="发布消息"></a
                    >发布消息
                  </h3>
                  <p>下面在 <code>for</code> 循环中 发布 5 条数据：</p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">RingBuffer&lt;LongEvent&gt; ringBuffer = disruptor.getRingBuffer();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>; l &lt; <span class="number">5</span>; l++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> ringBuffer.next();</span><br><span class="line">    <span class="type">LongEvent</span> <span class="variable">event</span> <span class="operator">=</span> ringBuffer.get(sequence);</span><br><span class="line">    event.set(<span class="number">100</span>+l);</span><br><span class="line">    System.out.println(<span class="string">&quot;publish event :&quot;</span> + l);</span><br><span class="line">    ringBuffer.publish(sequence);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    消息已经发布，下面需要设定当前<code>disruptor</code>的消费处理器。前面已经有个<code
                      >LongEvent</code
                    >
                    和 <code>EventFactory</code> ;
                    在<code>disruptor</code>中是通过
                    <code>EventHandler</code> 来进行消息消费的。
                  </p>
                  <h3 id="编写消费者代码">
                    <a
                      href="#编写消费者代码"
                      class="headerlink"
                      title="编写消费者代码"
                    ></a
                    >编写消费者代码
                  </h3>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongEventHandler</span> <span class="keyword">implements</span> <span class="title class_">EventHandler</span>&lt;LongEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(LongEvent event, <span class="type">long</span> sequence, <span class="type">boolean</span> endOfBatch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Event: &quot;</span> + event.getValue()+<span class="string">&quot; -&gt; &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    将 <code>eventHandler</code> 设置到
                    <code>disruptor</code> 的处理链上
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//将处理事件的事件处理程序 -&gt; 消费事件的处理程序</span></span><br><span class="line"><span class="type">LongEventHandler</span> <span class="variable">longEventHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongEventHandler</span>();</span><br><span class="line">disruptor.handleEventsWith(longEventHandler);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="运行结果（这里）：">
                    <a
                      href="#运行结果（这里）："
                      class="headerlink"
                      title="运行结果（这里）："
                    ></a
                    >运行结果（这里）：
                  </h3>
                  <figure class="highlight plaintext">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">publish event :0</span><br><span class="line">Event: 0 -&gt; disruptor-thread-1</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :1</span><br><span class="line">Event: 1 -&gt; disruptor-thread-1</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :2</span><br><span class="line">Event: 2 -&gt; disruptor-thread-1</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :3</span><br><span class="line">Event: 3 -&gt; disruptor-thread-1</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :4</span><br><span class="line">Event: 4 -&gt; disruptor-thread-1</span><br><span class="line">--------------------------------&gt;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h2 id="基本概念和原理">
                    <a
                      href="#基本概念和原理"
                      class="headerlink"
                      title="基本概念和原理"
                    ></a
                    >基本概念和原理
                  </h2>
                  <h3 id="Disruptor">
                    <a
                      href="#Disruptor"
                      class="headerlink"
                      title="Disruptor"
                    ></a
                    >Disruptor
                  </h3>
                  <p>
                    整个基于<code>ringBuffer</code>实现的生产者消费者模式的容器。主要属性
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RingBuffer&lt;T&gt; ringBuffer;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerRepository&lt;T&gt; consumerRepository = <span class="keyword">new</span> <span class="title class_">ConsumerRepository</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">started</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">private</span> ExceptionHandler&lt;? <span class="built_in">super</span> T&gt; exceptionHandler = <span class="keyword">new</span> <span class="title class_">ExceptionHandlerWrapper</span>&lt;&gt;();</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      <code>ringBuffer</code>：内部持有一个
                      <code>RingBuffer</code> 对象，<code>Disruptor</code>
                      内部的事件发布都是依赖这个<code>RingBuffer</code>对象完成的。
                    </li>
                    <li><code>executor</code>：消费事件的线程池</li>
                    <li>
                      <code>consumerRepository</code
                      >：提供存储库机制，用于将<code>EventHandler</code>与<code>EventProcessor</code>关联起来
                    </li>
                    <li>
                      <code>started</code> :
                      用于标志当前<code>Disruptor</code>是否已经启动
                    </li>
                    <li>
                      <code>exceptionHandler</code> :
                      异常处理器，用于处理<code>BatchEventProcessor</code>事件周期中
                      <code>uncaught exceptions</code> 。
                    </li>
                  </ul>
                  <h3 id="RingBuffer">
                    <a
                      href="#RingBuffer"
                      class="headerlink"
                      title="RingBuffer"
                    ></a
                    >RingBuffer
                  </h3>
                  <p>
                    环形队列[实现上是一个数组]，可以类比为<code>BlockingQueue</code>之类的队列，<code>ringBuffer</code>的使用，使得内存被循环使用，减少了某些场景的内存分配回收扩容等耗时操作。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RingBuffer</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">RingBufferFields</span>&lt;E&gt; </span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">Cursored</span>, EventSequencer&lt;E&gt;, EventSink&lt;E&gt; </span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      E：在事件的交换或并行协调期间存储用于共享的数据的实现
                      -&gt; 消息事件
                    </li>
                  </ul>
                  <h3 id="Sequencer">
                    <a
                      href="#Sequencer"
                      class="headerlink"
                      title="Sequencer"
                    ></a
                    >Sequencer
                  </h3>
                  <p>
                    <code>RingBuffer</code> 中
                    生产者的顶级父接口，其直接实现有<code>SingleProducerSequencer</code>和<code>MultiProducerSequencer</code>；对应
                    <code>SINGLE</code>、<code>MULTI</code> 两个枚举值。
                  </p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/16504080427c32c5~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <h3 id="EventHandler">
                    <a
                      href="#EventHandler"
                      class="headerlink"
                      title="EventHandler"
                    ></a
                    >EventHandler
                  </h3>
                  <p>
                    事件处置器，改接口用于对外扩展来实现具体的消费逻辑。如上面
                    <code>demo</code> 中的 <code>LongEventHandler</code> ;
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//回调接口，用于处理&#123;@link RingBuffer&#125;中可用的事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EventHandler</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(T event, <span class="type">long</span> sequence, <span class="type">boolean</span> endOfBatch)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>
                      <code>event</code> :
                      <code>RingBuffer</code> 已经发布的事件
                    </li>
                    <li><code>sequence</code> : 正在处理的事件 的序列号</li>
                    <li>
                      <code>endOfBatch</code> : 用来标识否是来自
                      <code>RingBuffer</code> 的批次中的最后一个事件
                    </li>
                  </ul>
                  <h3 id="SequenceBarrier">
                    <a
                      href="#SequenceBarrier"
                      class="headerlink"
                      title="SequenceBarrier"
                    ></a
                    >SequenceBarrier
                  </h3>
                  <p>
                    消费者路障。规定了消费者如何向下走。事实上，该路障算是变向的锁。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ProcessingSequenceBarrier</span> <span class="keyword">implements</span> <span class="title class_">SequenceBarrier</span> &#123;</span><br><span class="line">    <span class="comment">//当等待（探测）的需要不可用时，等待的策略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitStrategy waitStrategy;</span><br><span class="line">    <span class="comment">//依赖的其它Consumer的序号，这个用于依赖的消费的情况，</span></span><br><span class="line">    <span class="comment">//比如A、B两个消费者，只有A消费完，B才能消费。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sequence     dependentSequence;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span>   <span class="variable">alerted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//Ringbuffer的写入指针</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sequence     cursorSequence;</span><br><span class="line">    <span class="comment">//RingBuffer对应的Sequencer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sequencer    sequencer;</span><br><span class="line">    <span class="comment">//exclude method</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <code>waitStrategy</code> 决定了消费者采用何种等待策略。
                  </p>
                  <h3 id="WaitStrategy">
                    <a
                      href="#WaitStrategy"
                      class="headerlink"
                      title="WaitStrategy"
                    ></a
                    >WaitStrategy
                  </h3>
                  <blockquote>
                    <p>
                      Strategy employed for making {@link EventProcessor}s wait
                      on a cursor {@link Sequence}.
                    </p>
                  </blockquote>
                  <p>
                    <code>EventProcessor</code> 的等待策略；具体实现在
                    <code>disruptor</code> 中有8种，
                  </p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165040897c8cd0fd~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <p>
                    这些等待策略不同的核心体现是在如何实现
                    <code>waitFor</code> 这个方法上。
                  </p>
                  <h3 id="EventProcessor">
                    <a
                      href="#EventProcessor"
                      class="headerlink"
                      title="EventProcessor"
                    ></a
                    >EventProcessor
                  </h3>
                  <p>
                    事件处理器，实际上可以理解为消费者模型的框架，实现了线程<code>Runnable</code>的<code>run</code>方法，将循环判断等操作封在了里面。该接口有三个实现类:
                  </p>
                  <p><strong>1、BatchEventProcessor</strong></p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BatchEventProcessor</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">EventProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span>           <span class="variable">running</span>          <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">private</span> ExceptionHandler&lt;? <span class="built_in">super</span> T&gt;   exceptionHandler = <span class="keyword">new</span> <span class="title class_">FatalExceptionHandler</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataProvider&lt;T&gt;         dataProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SequenceBarrier         sequenceBarrier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventHandler&lt;? <span class="built_in">super</span> T&gt; eventHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Sequence</span>                <span class="variable">sequence</span>         <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sequence</span>(                                      Sequencer.INITIAL_CURSOR_VALUE);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeoutHandler          timeoutHandler;</span><br><span class="line">    <span class="comment">//exclude method</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <ul>
                    <li>ExceptionHandler：异常处理器</li>
                    <li>
                      DataProvider：数据来源，对应 <code>RingBuffer</code>
                    </li>
                    <li>EventHandler：处理 <code>Event</code> 的回调对象</li>
                    <li>SequenceBarrier：对应的序号屏障</li>
                    <li>
                      TimeoutHandler：超时处理器，默认情况为空，如果要设置，只需要要将关联的<code>EventHandler</code>实现<code>TimeOutHandler</code>即可。
                    </li>
                  </ul>
                  <p>
                    如果我们选择使用
                    <code>EventHandler</code> 的时候，默认使用的就是
                    <code>BatchEventProcessor</code
                    >，它与<code>EventHandler</code>是一一对应，并且是单线程执行。
                  </p>
                  <p>
                    如果某个<code>RingBuffer</code>有多个<code>BatchEventProcessor</code>，那么就会每个<code>BatchEventProcessor</code>对应一个线程。
                  </p>
                  <p><strong>2、WorkProcessor</strong></p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WorkProcessor</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">EventProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Sequence</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sequence</span>(Sequencer.INITIAL_CURSOR_VALUE);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RingBuffer&lt;T&gt; ringBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SequenceBarrier  sequenceBarrier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WorkHandler&lt;? <span class="built_in">super</span> T&gt; workHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExceptionHandler&lt;? <span class="built_in">super</span> T&gt; exceptionHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sequence workSequence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">EventReleaser</span> <span class="variable">eventReleaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventReleaser</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">                sequence.set(Long.MAX_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeoutHandler timeoutHandler;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    基本和
                    <code>BatchEventProcessor</code>
                    类似，不同在于，用于处理<code>Event</code>的回调对象是<code>WorkHandler</code>。
                  </p>
                  <h3 id="原理图">
                    <a href="#原理图" class="headerlink" title="原理图"></a
                    >原理图
                  </h3>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165040ee8a2eae73~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <h2
                    id="无消费者情况下，生产者保持生产，但是-remainingCapacity-保持不变"
                  >
                    <a
                      href="#无消费者情况下，生产者保持生产，但是-remainingCapacity-保持不变"
                      class="headerlink"
                      title="无消费者情况下，生产者保持生产，但是 remainingCapacity 保持不变"
                    ></a
                    >无消费者情况下，生产者保持生产，但是
                    <code>remainingCapacity</code> 保持不变
                  </h2>
                  <p>
                    在写<code>demo</code>的过程中，本来想通过不设定 消费者
                    来观察
                    <code>RingBuffer</code>
                    可用容量变化的。但是验证过程中，一直得不到预期的结果，(注：没有设置消费者，只有生产者)，先看结果：
                  </p>
                  <figure class="highlight plaintext">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">publish event :0</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:0</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :1</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:1</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :2</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:2</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :3</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:3</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :4</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:4</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :5</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:5</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :6</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:6</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :7</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:7</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :8</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:8</span><br><span class="line">--------------------------------&gt;</span><br><span class="line">publish event :9</span><br><span class="line">bufferSie:8</span><br><span class="line">remainingCapacity:8</span><br><span class="line">cursor:9</span><br><span class="line">--------------------------------&gt;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    从结果来看，<code>remainingCapacity</code> 的值应该随着
                    发布的数量 递减的；但是实际上它并没有发生任何变化。
                  </p>
                  <p>
                    来看下<code>ringBuffer.remainingCapacity()</code> 这个方法：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the remaining capacity for this ringBuffer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The number of slots remaining.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">remainingCapacity</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> sequencer.remainingCapacity();</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    这里面又使用
                    <code>sequencer.remainingCapacity()</code
                    >这个方法来计算的。上面的例子中使用的是<code>ProducerType.SINGLE</code>，那来看<code
                      >SingleProducerSequencer</code
                    >
                    这个里面<code>remainingCapacity</code>的实现。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">remainingCapacity</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//上次申请完毕的序列值</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">nextValue</span> <span class="operator">=</span> <span class="built_in">this</span>.nextValue;</span><br><span class="line">    <span class="comment">//计算当前已经消费到的序列值</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">consumed</span> <span class="operator">=</span> Util.getMinimumSequence(gatingSequences, nextValue);</span><br><span class="line">    <span class="comment">//当前生产到的序列值</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">produced</span> <span class="operator">=</span> nextValue;</span><br><span class="line">    <span class="keyword">return</span> getBufferSize() - (produced - consumed);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>来解释下这段代码的含义：</p>
                  <p>
                    假设当前 <code>ringBuffer</code> 的
                    <code>bufferSize</code> 是 8 ；上次申请到的序列号是
                    5，其实也就是说已经生产过占用的序列号是5；假设当前已经消费到的序列号是
                    3，那么剩余的容量为： 8-（5-2） &#x3D; 5；
                  </p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/1650414723061ce7~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <p>
                    因为这里我们可以确定 <code>bufferSize</code> 和
                    <code>produced</code> 的值了，那么
                    <code>remainingCapacity</code>
                    的结果就取决于<code>getMinimumSequence</code>的计算结果了。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getMinimumSequence</span><span class="params">(<span class="keyword">final</span> Sequence[] sequences, <span class="type">long</span> minimum)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, n = sequences.length; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> sequences[i].get();</span><br><span class="line">        minimum = Math.min(minimum, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minimum;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    这个方法是从 <code>Sequence</code> 数组中获取最小序列
                    。如果<code>sequences</code> 为空，则返回
                    <code>minimum</code
                    >。回到上一步，看下<code>sequences</code>这个数组是从哪里过来的，它的值在哪里设置的。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="type">long</span> <span class="variable">consumed</span> <span class="operator">=</span> Util.getMinimumSequence(gatingSequences, nextValue);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <code>gatingSequences </code>是
                    <code>SingleProducerSequencer </code>父类
                    <code>AbstractSequencer</code> 中的成员变量：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> Sequence[] gatingSequences = <span class="keyword">new</span> <span class="title class_">Sequence</span>[<span class="number">0</span>];</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    <code>gatingSequences</code> 是在下面这个方法里面来管理的。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Sequencer#addGatingSequences(Sequence...)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addGatingSequences</span><span class="params">(Sequence... gatingSequences)</span></span><br><span class="line">&#123;</span><br><span class="line">    SequenceGroups.addSequences(<span class="built_in">this</span>, SEQUENCE_UPDATER, <span class="built_in">this</span>, gatingSequences);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>这个方法的调用栈向前追溯有这几个地方调用了：</p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/1650415d0682db8f~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <p>
                    <code>WorkerPool</code>来管理多个消费者；<code
                      >hangdlerEventsWith</code
                    >
                    这个方法也是用来设置消费者的。但是在上面的测试案例中我们是想通过不设定消费者
                    只设定生成者 来观察 环形队列的占用情况，所以<code
                      >gatingSequences</code
                    >
                    会一直是空的，因此在计算时会把
                    <code>produced</code> 的值作为
                    <code>minimum</code> 返回。这样每次计算就相当于：
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">return</span> getBufferSize() - (produced - produced) === getBufferSize();</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    也就验证了为何在不设定消费者的情况下，<code
                      >remainingCapacity</code
                    >
                    的值会一直保持不变。
                  </p>
                  <h2 id="SOFATracer-中-Disruptor-实践">
                    <a
                      href="#SOFATracer-中-Disruptor-实践"
                      class="headerlink"
                      title="SOFATracer 中 Disruptor 实践"
                    ></a
                    >SOFATracer 中 Disruptor 实践
                  </h2>
                  <p>
                    <code>SOFATracer</code>中，<code
                      >AsyncCommonDigestAppenderManager</code
                    >
                    对
                    <code>disruptor</code>
                    进行了封装，用于处理外部组件的<code>Tracer</code>摘要日志。该部分借助
                    <code>AsyncCommonDigestAppenderManager</code>
                    的源码来分析下<code>SOFATracer</code>如何使用<code>disruptor</code>的。
                  </p>
                  <p>
                    <code>SOFATracer </code
                    >中使用了两种不同的事件模型，一种是<code>SOFATracer</code>内部使用的
                    <code>StringEvent</code> , 一种是 外部扩展使用的
                    <code>SofaTacerSpanEvent</code>。这里以
                    <code>SofaTacerSpanEvent</code> 这种事件模型来分析。<code
                      >StringEvent</code
                    >
                    消息事件模型对应的是
                    <code>AsyncCommonAppenderManager</code>
                    类封装的<code>disruptor</code>。
                  </p>
                  <h3 id="SofaTracerSpanEvent-gt-LongEvent">
                    <a
                      href="#SofaTracerSpanEvent-gt-LongEvent"
                      class="headerlink"
                      title="SofaTracerSpanEvent ( -&gt; LongEvent)"
                    ></a
                    >SofaTracerSpanEvent ( -&gt; LongEvent)
                  </h3>
                  <p>
                    定义消息事件模型，<code>SofaTacerSpanEvent</code> 和 前面
                    <code>demo</code> 中的
                    <code>LongEvent</code>
                    基本结构是一样的，主要是内部持有的消息数据不同，<code
                      >LongEvent</code
                    >
                    中是一个<code>long</code>类型的数据，<code>SofaTacerSpanEvent</code>中持有的是
                    <code>SofaTracerSpan</code> 。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaTracerSpanEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> SofaTracerSpan sofaTracerSpan;</span><br><span class="line">    <span class="keyword">public</span> SofaTracerSpan <span class="title function_">getSofaTracerSpan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sofaTracerSpan;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSofaTracerSpan</span><span class="params">(SofaTracerSpan sofaTracerSpan)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sofaTracerSpan = sofaTracerSpan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="Consumer-gt-LongEventHandler">
                    <a
                      href="#Consumer-gt-LongEventHandler"
                      class="headerlink"
                      title="Consumer ( -&gt; LongEventHandler)"
                    ></a
                    >Consumer ( -&gt; LongEventHandler)
                  </h3>
                  <p>
                    <code>Consumer</code> 是
                    <code>AsyncCommonDigestAppenderManager</code>
                    的内部类;实现了
                    <code>EventHandler</code>
                    接口，这个<code>consumer</code>就是作为消费者存在的。
                  </p>
                  <p>
                    在<code>AsyncCommonAppenderManager</code>中也有一个，这个地方个人觉得可以抽出去，这样可以使得<code>AsyncCommonDigestAppenderManager/AsyncCommonAppenderManager</code>的代码看起来更干净；
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">EventHandler</span>&lt;SofaTracerSpanEvent&gt; &#123;</span><br><span class="line">       <span class="comment">//日志类型集合，非该集合内的日志类型将不会被处理</span></span><br><span class="line">        <span class="keyword">protected</span> Set&lt;String&gt; logTypes = Collections.synchronizedSet(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;());</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(SofaTracerSpanEvent event, <span class="type">long</span> sequence, <span class="type">boolean</span> endOfBatch)</span></span><br><span class="line">                                <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 拿到具体的消息数据 sofaTracerSpan</span></span><br><span class="line">            <span class="type">SofaTracerSpan</span> <span class="variable">sofaTracerSpan</span> <span class="operator">=</span> event.getSofaTracerSpan();</span><br><span class="line">            <span class="comment">// 如果没有数据，则不做任何处理</span></span><br><span class="line">            <span class="keyword">if</span> (sofaTracerSpan != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">logType</span> <span class="operator">=</span> sofaTracerSpan.getLogType();</span><br><span class="line">                    <span class="comment">// 验证当前日志类型是否可以被当前consumer消费</span></span><br><span class="line">                    <span class="keyword">if</span> (logTypes.contains(logType)) &#123;</span><br><span class="line">                        <span class="comment">// 获取编码类型</span></span><br><span class="line">                        <span class="type">SpanEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> contextEncoders.get(logType);</span><br><span class="line">                        <span class="comment">//获取 appender</span></span><br><span class="line">                        <span class="type">TraceAppender</span> <span class="variable">appender</span> <span class="operator">=</span> appenders.get(logType);</span><br><span class="line">                        <span class="comment">// 对数据进行编码处理</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">encodedStr</span> <span class="operator">=</span> encoder.encode(sofaTracerSpan);</span><br><span class="line">                        <span class="keyword">if</span> (appender <span class="keyword">instanceof</span> LoadTestAwareAppender) &#123;</span><br><span class="line">                            ((LoadTestAwareAppender) appender).append(encodedStr,</span><br><span class="line">                                TracerUtils.isLoadTest(sofaTracerSpan));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            appender.append(encodedStr);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 刷新缓冲区，日志输出</span></span><br><span class="line">                        appender.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="comment">// 异常省略</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addLogType</span><span class="params">(String logType)</span> &#123;</span><br><span class="line">            logTypes.add(logType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="SofaTracerSpanEventFactory-（-gt-LongEventFactory）">
                    <a
                      href="#SofaTracerSpanEventFactory-（-gt-LongEventFactory）"
                      class="headerlink"
                      title="SofaTracerSpanEventFactory （-&gt; LongEventFactory）"
                    ></a
                    >SofaTracerSpanEventFactory （-&gt; LongEventFactory）
                  </h3>
                  <p>用于产生消息事件的 <code>Factory</code></p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaTracerSpanEventFactory</span> <span class="keyword">implements</span> <span class="title class_">EventFactory</span>&lt;SofaTracerSpanEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SofaTracerSpanEvent <span class="title function_">newInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SofaTracerSpanEvent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="ConsumerThreadFactory-gt-LongEventThreadFactory">
                    <a
                      href="#ConsumerThreadFactory-gt-LongEventThreadFactory"
                      class="headerlink"
                      title="ConsumerThreadFactory (-&gt; LongEventThreadFactory )"
                    ></a
                    >ConsumerThreadFactory (-&gt; LongEventThreadFactory )
                  </h3>
                  <p>用来产生消费线程的 <code>Factory</code>。</p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String workName;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getWorkName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> workName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWorkName</span><span class="params">(String workName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.workName = workName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;Tracer-AsyncConsumer-Thread-&quot;</span> + workName);</span><br><span class="line">        worker.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> worker;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="构建disruptor">
                    <a
                      href="#构建disruptor"
                      class="headerlink"
                      title="构建disruptor"
                    ></a
                    >构建disruptor
                  </h3>
                  <p>
                    <code>disruptor</code> 的构建是在
                    <code>AsyncCommonDigestAppenderManager</code>
                    的构造函数中完成的。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="title function_">AsyncCommonDigestAppenderManager</span><span class="params">(<span class="type">int</span> queueSize, <span class="type">int</span> consumerNumber)</span> &#123;</span><br><span class="line">    <span class="comment">// 使用这个计算来保证realQueueSize是2的次幂（返回当前 大于等于queueSize的最小的2的次幂数 ）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">realQueueSize</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; (<span class="number">32</span> - Integer.numberOfLeadingZeros(queueSize - <span class="number">1</span>));</span><br><span class="line">    <span class="comment">//构建disruptor，使用的是 ProducerType.MULTI</span></span><br><span class="line">    <span class="comment">//等待策略是 BlockingWaitStrategy</span></span><br><span class="line">    disruptor = <span class="keyword">new</span> <span class="title class_">Disruptor</span>&lt;SofaTracerSpanEvent&gt;(<span class="keyword">new</span> <span class="title class_">SofaTracerSpanEventFactory</span>(),</span><br><span class="line">        realQueueSize, threadFactory, ProducerType.MULTI, <span class="keyword">new</span> <span class="title class_">BlockingWaitStrategy</span>());</span><br><span class="line">    <span class="comment">//消费者列表</span></span><br><span class="line">    <span class="built_in">this</span>.consumers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Consumer&gt;(consumerNumber);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; consumerNumber; i++) &#123;</span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>();</span><br><span class="line">        consumers.add(consumer);</span><br><span class="line">        <span class="comment">//设置异常处理程序</span></span><br><span class="line">        disruptor.setDefaultExceptionHandler(<span class="keyword">new</span> <span class="title class_">ConsumerExceptionHandler</span>());</span><br><span class="line">        <span class="comment">//绑定消费者</span></span><br><span class="line">        disruptor.handleEventsWith(consumer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否允许丢弃，从配置文件获取</span></span><br><span class="line">    <span class="built_in">this</span>.allowDiscard = Boolean.parseBoolean(SofaTracerConfiguration.getProperty(</span><br><span class="line">        SofaTracerConfiguration.TRACER_ASYNC_APPENDER_ALLOW_DISCARD, DEFAULT_ALLOW_DISCARD));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (allowDiscard) &#123;</span><br><span class="line">        <span class="comment">//是否记录丢失日志的数量</span></span><br><span class="line">        <span class="built_in">this</span>.isOutDiscardNumber = Boolean.parseBoolean(SofaTracerConfiguration.getProperty(</span><br><span class="line">            SofaTracerConfiguration.TRACER_ASYNC_APPENDER_IS_OUT_DISCARD_NUMBER,</span><br><span class="line">            DEFAULT_IS_OUT_DISCARD_NUMBER));</span><br><span class="line">        <span class="comment">//是否记录丢失日志的TraceId和RpcId</span></span><br><span class="line">        <span class="built_in">this</span>.isOutDiscardId = Boolean.parseBoolean(SofaTracerConfiguration.getProperty(</span><br><span class="line">            SofaTracerConfiguration.TRACER_ASYNC_APPENDER_IS_OUT_DISCARD_ID,</span><br><span class="line">            DEFAULT_IS_OUT_DISCARD_ID));</span><br><span class="line">        <span class="comment">//丢失日志的数量达到该阈值进行一次日志输出</span></span><br><span class="line">        <span class="built_in">this</span>.discardOutThreshold = Long.parseLong(SofaTracerConfiguration.getProperty(</span><br><span class="line">            SofaTracerConfiguration.TRACER_ASYNC_APPENDER_DISCARD_OUT_THRESHOLD,</span><br><span class="line">            DEFAULT_DISCARD_OUT_THRESHOLD));</span><br><span class="line">        <span class="keyword">if</span> (isOutDiscardNumber) &#123;</span><br><span class="line">            <span class="built_in">this</span>.discardCount = <span class="keyword">new</span> <span class="title class_">PaddedAtomicLong</span>(<span class="number">0L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <h3 id="启动-disruptor">
                    <a
                      href="#启动-disruptor"
                      class="headerlink"
                      title="启动 disruptor"
                    ></a
                    >启动 disruptor
                  </h3>
                  <p>
                    <code>disruptor</code>的启动委托给了<code>
                      AsyncCommonDigestAppenderManager</code
                    >
                    的<code>start</code>方法来执行。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="keyword">final</span> String workerName)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.threadFactory.setWorkName(workerName);</span><br><span class="line">    <span class="built_in">this</span>.ringBuffer = <span class="built_in">this</span>.disruptor.start();</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>
                    来看下，<code>SOFATracer</code> 中 具体是在哪里调用这个<code
                      >start</code
                    >
                    的：
                  </p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165041aeac0dc066~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <ul>
                    <li>
                      <code>CommonTracerManager</code> : 这个里面持有了<code
                        >AsyncCommonDigestAppenderManager</code
                      >
                      类的一个单例对象，并且是<code>static</code>
                      静态代码块中调用了<code>start</code>方法；这个用来输出普通日志。
                    </li>
                    <li>
                      <code>SofaTracerDigestReporterAsyncManager</code
                      >：这里类里面也是持有了<code
                        >AsyncCommonDigestAppenderManager</code
                      >
                      类的一个单例对像，并且提供了<code>getSofaTracerDigestReporterAsyncManager</code>方法来获取该单例，在这个方法中调用了<code>start</code>方法；该对象用来输出摘要日志。
                    </li>
                  </ul>
                  <h3 id="发布事件">
                    <a href="#发布事件" class="headerlink" title="发布事件"></a
                    >发布事件
                  </h3>
                  <p>
                    前面的<code>demo</code>中是通过一个<code>for</code>循环来发布事件的，在
                    <code>SOFATracer</code> 中
                    的事件发布无非就是当有<code>Tracer</code>日志需要输出时会触发发布，那么对应的就是日志的
                    <code>append</code> 操作，将日志
                    <code>append</code> 到环形缓冲区。
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">append</span><span class="params">(SofaTracerSpan sofaTracerSpan)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">//是否允许丢弃</span></span><br><span class="line">    <span class="keyword">if</span> (allowDiscard) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//允许丢弃就使用tryNext尝试申请序列，申请不到抛出异常</span></span><br><span class="line">            sequence = ringBuffer.tryNext();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InsufficientCapacityException e) &#123;</span><br><span class="line">            <span class="comment">//是否输出丢失日志的TraceId和RpcId</span></span><br><span class="line">            <span class="keyword">if</span> (isOutDiscardId) &#123;</span><br><span class="line">                <span class="type">SofaTracerSpanContext</span> <span class="variable">sofaTracerSpanContext</span> <span class="operator">=</span> sofaTracerSpan</span><br><span class="line">                    .getSofaTracerSpanContext();</span><br><span class="line">                <span class="keyword">if</span> (sofaTracerSpanContext != <span class="literal">null</span>) &#123;</span><br><span class="line">                    SynchronizingSelfLog.warn(<span class="string">&quot;discarded tracer: traceId[&quot;</span></span><br><span class="line">                                              + sofaTracerSpanContext.getTraceId()</span><br><span class="line">                                              + <span class="string">&quot;];spanId[&quot;</span> + sofaTracerSpanContext.getSpanId()</span><br><span class="line">                                              + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">             <span class="comment">//是否输出丢失日志的数量</span></span><br><span class="line">            <span class="keyword">if</span> ((isOutDiscardNumber) &amp;&amp; discardCount.incrementAndGet() == discardOutThreshold) &#123;</span><br><span class="line">                discardCount.set(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (isOutDiscardNumber) &#123;</span><br><span class="line">                    SynchronizingSelfLog.warn(<span class="string">&quot;discarded &quot;</span> + discardOutThreshold + <span class="string">&quot; logs&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不允许丢弃则使用next方法</span></span><br><span class="line">        sequence = ringBuffer.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SofaTracerSpanEvent</span> <span class="variable">event</span> <span class="operator">=</span> ringBuffer.get(sequence);</span><br><span class="line">        event.setSofaTracerSpan(sofaTracerSpan);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        SynchronizingSelfLog.error(<span class="string">&quot;fail to add event&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发布</span></span><br><span class="line">    ringBuffer.publish(sequence);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>

                  <p>SOFATracer 事件发布的调用逻辑：</p>
                  <p>
                    <img
                      src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/8/4/165041c4514a3102~tplv-t2oaga2asx-image.image"
                    />
                  </p>
                  <p>
                    追溯调用的流程，可以知道当前 <code>span</code> 调用
                    <code>finish</code>时或者
                    <code>SOFATracer</code>中调用<code>reportSpan</code>时
                    就相当于发布了一个消息事件。
                  </p>
                  <h2 id="小结">
                    <a href="#小结" class="headerlink" title="小结"></a>小结
                  </h2>
                  <p>
                    本文对 <code>SOFATracer</code> 中使用
                    <code>Disruptor</code>
                    来进行日志输出的代码进行了简单的分析，更多内部细节原理可以自行看下<code>SOFATracer</code>的代码。<code
                      >SOFATracer</code
                    >
                    作为一种比较底层的中间件组件，在实际的业务开发中基本是无法感知的。但是作为技术来学习，还是有很多点可以挖一挖。
                  </p>
                  <p>
                    <a
                      target="_blank"
                      rel="noopener"
                      href="https://github.com/alipay/sofa-tracer"
                      >SOFATracer GitHub 传送门</a
                    >。
                  </p>
                </div>
                <div class="article-licensing box">
                  <div class="licensing-title">
                    <p>SOFATracer 中 Disruptor 实践</p>
                    <p>
                      <a
                        href="http://sunknightzy.github.io/2018/11/10/sofa/sofa-tracer-disruptor/"
                        >http://sunknightzy.github.io/2018/11/10/sofa/sofa-tracer-disruptor/</a
                      >
                    </p>
                  </div>
                  <div class="licensing-meta level is-mobile">
                    <div class="level-left">
                      <div class="level-item is-narrow">
                        <div>
                          <h6>作者</h6>
                          <p>J.Queue</p>
                        </div>
                      </div>
                      <div class="level-item is-narrow">
                        <div>
                          <h6>发布于</h6>
                          <p>2018-11-10</p>
                        </div>
                      </div>
                      <div class="level-item is-narrow">
                        <div>
                          <h6>更新于</h6>
                          <p>2022-04-23</p>
                        </div>
                      </div>
                      <div class="level-item is-narrow">
                        <div>
                          <h6>许可协议</h6>
                          <p>
                            <a
                              class="icons"
                              rel="noopener"
                              target="_blank"
                              title="Creative Commons"
                              href="https://creativecommons.org/"
                              ><i class="icon fab fa-creative-commons"></i
                            ></a>
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="article-tags is-size-7 mb-4">
                  <span class="mr-2">#</span
                  ><a class="link-muted mr-2" rel="tag" href="/tags/Tracer/"
                    >Tracer</a
                  ><a
                    class="link-muted mr-2"
                    rel="tag"
                    href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/"
                    >分布式链路跟踪</a
                  ><a class="link-muted mr-2" rel="tag" href="/tags/Disruptor/"
                    >Disruptor</a
                  >
                </div>
                <!--!-->
              </article>
            </div>
            <div class="card">
              <div class="card-content">
                <h3 class="menu-label has-text-centered">
                  喜欢这篇文章？打赏一下作者吧
                </h3>
                <div class="buttons is-centered">
                  <a class="button donate" data-type="alipay"
                    ><span class="icon is-small"
                      ><i class="fab fa-alipay"></i></span
                    ><span>支付宝</span
                    ><span class="qrcode"
                      ><img src="/img/zfb.JPG" alt="支付宝" /></span></a
                  ><a class="button donate" data-type="wechat"
                    ><span class="icon is-small"
                      ><i class="fab fa-weixin"></i></span
                    ><span>微信</span
                    ><span class="qrcode"
                      ><img src="/img/pay.JPG" alt="微信" /></span
                  ></a>
                </div>
              </div>
            </div>
            <nav class="post-navigation mt-4 level is-mobile">
              <div class="level-start">
                <a
                  class="article-nav-prev level level-item link-muted"
                  href="/2018/11/10/sofa/sofa-tracer-zipkin-model-convert/"
                  ><i class="level-item fas fa-chevron-left"></i
                  ><span class="level-item"
                    >分布式链路跟踪组件 SOFATracer 和 Zipkin 模型转换原理</span
                  ></a
                >
              </div>
              <div class="level-end">
                <a
                  class="article-nav-next level level-item link-muted"
                  href="/2018/10/30/middleware/middleware-http-resttemplate/"
                  ><span class="level-item">聊一聊 RestTemplate</span
                  ><i class="level-item fas fa-chevron-right"></i
                ></a>
              </div>
            </nav>
            <div class="card">
              <div class="card-content">
                <h3 class="title is-5">评论</h3>
                <div id="comment-container"></div>
                <link
                  rel="stylesheet"
                  href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"
                />
                <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
                <script>
                  var gitalk = new Gitalk({
                    id: '9139e6f5760993a39ae1167f86d162da',
                    repo: 'glmapper.github.io',
                    owner: 'glmapper',
                    clientID: 'd25147ddf77e70d7adfe',
                    clientSecret: 'c10bbd1ba7a09c96e4106709107d4da85d60be78',
                    admin: ['glmapper'],
                    createIssueManually: false,
                    distractionFreeMode: true,
                    perPage: 20,
                    pagerDirection: 'last',

                    enableHotKey: true,
                    language: 'zh-CN',
                  })
                  gitalk.render('comment-container')
                </script>
              </div>
            </div>
          </div>
          <div
            class="column column-left is-4-tablet is-4-desktop is-3-widescreen order-1 is-sticky"
          >
            <div class="card widget" data-type="profile">
              <div class="card-content">
                <nav class="level">
                  <div class="level-item has-text-centered flex-shrink-1">
                    <div>
                      <figure class="image is-128x128 mx-auto mb-2">
                        <img
                          class="avatar is-rounded"
                          src="/img/self.png"
                          alt="J.Queue"
                        />
                      </figure>
                      <p
                        class="title is-size-4 is-block"
                        style="line-height: inherit"
                      >
                        J.Queue
                      </p>
                      <p class="is-size-6 is-block">Java Developer</p>
                      <p class="is-size-6 is-flex justify-content-center">
                        <i class="fas fa-map-marker-alt mr-1"></i
                        ><span>🇨🇳 China</span>
                      </p>
                    </div>
                  </div>
                </nav>
                <nav class="level is-mobile">
                  <div class="level-item has-text-centered is-marginless">
                    <div>
                      <p class="heading">文章</p>
                      <a href="/archives"><p class="title">108</p></a>
                    </div>
                  </div>
                  <div class="level-item has-text-centered is-marginless">
                    <div>
                      <p class="heading">分类</p>
                      <a href="/categories"><p class="title">17</p></a>
                    </div>
                  </div>
                  <div class="level-item has-text-centered is-marginless">
                    <div>
                      <p class="heading">标签</p>
                      <a href="/tags"><p class="title">128</p></a>
                    </div>
                  </div>
                </nav>
                <div class="level">
                  <a
                    class="level-item button is-primary is-rounded"
                    href="https://github.com/glmapper"
                    target="_blank"
                    rel="noopener"
                    >关注我</a
                  >
                </div>
                <div class="level is-mobile is-multiline">
                  <a
                    class="level-item button is-transparent is-marginless"
                    target="_blank"
                    rel="noopener"
                    title="Github"
                    href="https://github.com/glmapper"
                    ><i class="fab fa-github"></i></a
                  ><a
                    class="level-item button is-transparent is-marginless"
                    target="_blank"
                    rel="noopener"
                    title="Twitter"
                    href="https://twitter.com"
                    ><i class="fab fa-twitter"></i></a
                  ><a
                    class="level-item button is-transparent is-marginless"
                    target="_blank"
                    rel="noopener"
                    title="weibo"
                    href="https://weibo.com/u/2412872703"
                    ><i class="fab fa-weibo"></i></a
                  ><a
                    class="level-item button is-transparent is-marginless"
                    target="_blank"
                    rel="noopener"
                    title="RSS"
                    href="/atom.xml"
                    ><i class="fas fa-rss"></i
                  ></a>
                </div>
              </div>
            </div>
            <div class="card widget" data-type="links">
              <div class="card-content">
                <div class="menu">
                  <h3 class="menu-label">链接</h3>
                  <ul class="menu-list">
                    <li>
                      <a
                        class="level is-mobile"
                        href="https://juejin.cn/user/3227821827961806"
                        target="_blank"
                        rel="noopener"
                        ><span class="level-left"
                          ><span class="level-item">掘金社区</span></span
                        ><span class="level-right"
                          ><span class="level-item tag">juejin.cn</span></span
                        ></a
                      >
                    </li>
                    <li>
                      <a
                        class="level is-mobile"
                        href="https://www.sofastack.tech/"
                        target="_blank"
                        rel="noopener"
                        ><span class="level-left"
                          ><span class="level-item">SOFAStack</span></span
                        ><span class="level-right"
                          ><span class="level-item tag"
                            >www.sofastack.tech</span
                          ></span
                        ></a
                      >
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card widget" id="toc" data-type="toc">
              <div class="card-content">
                <div class="menu">
                  <h3 class="menu-label">目录</h3>
                  <ul class="menu-list">
                    <li>
                      <a class="level is-mobile" href="#OpenTraceing-规范"
                        ><span class="level-left"
                          ><span class="level-item">1</span
                          ><span class="level-item"
                            >OpenTraceing 规范</span
                          ></span
                        ></a
                      >
                    </li>
                    <li>
                      <a
                        class="level is-mobile"
                        href="#SOFATracer-对-OpenTraceing-的实现"
                        ><span class="level-left"
                          ><span class="level-item">2</span
                          ><span class="level-item"
                            >SOFATracer 对 OpenTraceing 的实现</span
                          ></span
                        ></a
                      >
                      <ul class="menu-list">
                        <li>
                          <a class="level is-mobile" href="#概念"
                            ><span class="level-left"
                              ><span class="level-item">2.1</span
                              ><span class="level-item">概念</span></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#Tracer"
                            ><span class="level-left"
                              ><span class="level-item">2.2</span
                              ><span class="level-item">Tracer</span></span
                            ></a
                          >
                          <ul class="menu-list">
                            <li>
                              <a
                                class="level is-mobile"
                                href="#启动一个新的span"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.1</span
                                  ><span class="level-item"
                                    >启动一个新的span</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a
                                class="level is-mobile"
                                href="#将SpanContext上下文Inject（注入）到carrier"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.2</span
                                  ><span class="level-item"
                                    >将SpanContext上下文Inject（注入）到carrier</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a
                                class="level is-mobile"
                                href="#将SpanContext上下文从carrier中Extract（提取）"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.3</span
                                  ><span class="level-item"
                                    >将SpanContext上下文从carrier中Extract（提取）</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#Format"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.4</span
                                  ><span class="level-item">Format</span></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#X-B3"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.5</span
                                  ><span class="level-item">X-B3</span></span
                                ></a
                              >
                            </li>
                            <li>
                              <a
                                class="level is-mobile"
                                href="#SOFATracer-中的-Format"
                                ><span class="level-left"
                                  ><span class="level-item">2.2.6</span
                                  ><span class="level-item"
                                    >SOFATracer 中的 Format</span
                                  ></span
                                ></a
                              >
                            </li>
                          </ul>
                        </li>
                        <li>
                          <a class="level is-mobile" href="#Span"
                            ><span class="level-left"
                              ><span class="level-item">2.3</span
                              ><span class="level-item">Span</span></span
                            ></a
                          >
                          <ul class="menu-list">
                            <li>
                              <a
                                class="level is-mobile"
                                href="#通过Span获取SpanContext"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.1</span
                                  ><span class="level-item"
                                    >通过Span获取SpanContext</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#复写操作名"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.2</span
                                  ><span class="level-item"
                                    >复写操作名</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#结束Span"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.3</span
                                  ><span class="level-item"
                                    >结束Span</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#为Span设置tag"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.4</span
                                  ><span class="level-item"
                                    >为Span设置tag</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#Log结构化数据"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.5</span
                                  ><span class="level-item"
                                    >Log结构化数据</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a
                                class="level is-mobile"
                                href="#设置一个baggage（随行数据）元素"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.6</span
                                  ><span class="level-item"
                                    >设置一个baggage（随行数据）元素</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a
                                class="level is-mobile"
                                href="#SofaTracerSpan-中的属性"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.7</span
                                  ><span class="level-item"
                                    >SofaTracerSpan 中的属性</span
                                  ></span
                                ></a
                              >
                            </li>
                            <li>
                              <a class="level is-mobile" href="#SpanContext"
                                ><span class="level-left"
                                  ><span class="level-item">2.3.8</span
                                  ><span class="level-item"
                                    >SpanContext</span
                                  ></span
                                ></a
                              >
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a class="level is-mobile" href="#Disruptor-简介"
                        ><span class="level-left"
                          ><span class="level-item">3</span
                          ><span class="level-item">Disruptor 简介</span></span
                        ></a
                      >
                    </li>
                    <li>
                      <a class="level is-mobile" href="#案例"
                        ><span class="level-left"
                          ><span class="level-item">4</span
                          ><span class="level-item">案例</span></span
                        ></a
                      >
                      <ul class="menu-list">
                        <li>
                          <a
                            class="level is-mobile"
                            href="#消息事件-LongEvent-，能够被消费的数据载体"
                            ><span class="level-left"
                              ><span class="level-item">4.1</span
                              ><span class="level-item"
                                >消息事件 LongEvent ，能够被消费的数据载体</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a
                            class="level is-mobile"
                            href="#创建消息事件的factory"
                            ><span class="level-left"
                              ><span class="level-item">4.2</span
                              ><span class="level-item"
                                >创建消息事件的factory</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a
                            class="level is-mobile"
                            href="#ConsumerThreadFactory"
                            ><span class="level-left"
                              ><span class="level-item">4.3</span
                              ><span class="level-item"
                                >ConsumerThreadFactory</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#发布消息"
                            ><span class="level-left"
                              ><span class="level-item">4.4</span
                              ><span class="level-item">发布消息</span></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#编写消费者代码"
                            ><span class="level-left"
                              ><span class="level-item">4.5</span
                              ><span class="level-item"
                                >编写消费者代码</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#运行结果（这里）："
                            ><span class="level-left"
                              ><span class="level-item">4.6</span
                              ><span class="level-item"
                                >运行结果（这里）：</span
                              ></span
                            ></a
                          >
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a class="level is-mobile" href="#基本概念和原理"
                        ><span class="level-left"
                          ><span class="level-item">5</span
                          ><span class="level-item">基本概念和原理</span></span
                        ></a
                      >
                      <ul class="menu-list">
                        <li>
                          <a class="level is-mobile" href="#Disruptor"
                            ><span class="level-left"
                              ><span class="level-item">5.1</span
                              ><span class="level-item">Disruptor</span></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#RingBuffer"
                            ><span class="level-left"
                              ><span class="level-item">5.2</span
                              ><span class="level-item">RingBuffer</span></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#Sequencer"
                            ><span class="level-left"
                              ><span class="level-item">5.3</span
                              ><span class="level-item">Sequencer</span></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#EventHandler"
                            ><span class="level-left"
                              ><span class="level-item">5.4</span
                              ><span class="level-item"
                                >EventHandler</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#SequenceBarrier"
                            ><span class="level-left"
                              ><span class="level-item">5.5</span
                              ><span class="level-item"
                                >SequenceBarrier</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#WaitStrategy"
                            ><span class="level-left"
                              ><span class="level-item">5.6</span
                              ><span class="level-item"
                                >WaitStrategy</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#EventProcessor"
                            ><span class="level-left"
                              ><span class="level-item">5.7</span
                              ><span class="level-item"
                                >EventProcessor</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#原理图"
                            ><span class="level-left"
                              ><span class="level-item">5.8</span
                              ><span class="level-item">原理图</span></span
                            ></a
                          >
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a
                        class="level is-mobile"
                        href="#无消费者情况下，生产者保持生产，但是-remainingCapacity-保持不变"
                        ><span class="level-left"
                          ><span class="level-item">6</span
                          ><span class="level-item"
                            >无消费者情况下，生产者保持生产，但是
                            remainingCapacity 保持不变</span
                          ></span
                        ></a
                      >
                    </li>
                    <li>
                      <a
                        class="level is-mobile"
                        href="#SOFATracer-中-Disruptor-实践"
                        ><span class="level-left"
                          ><span class="level-item">7</span
                          ><span class="level-item"
                            >SOFATracer 中 Disruptor 实践</span
                          ></span
                        ></a
                      >
                      <ul class="menu-list">
                        <li>
                          <a
                            class="level is-mobile"
                            href="#SofaTracerSpanEvent-gt-LongEvent"
                            ><span class="level-left"
                              ><span class="level-item">7.1</span
                              ><span class="level-item"
                                >SofaTracerSpanEvent ( -&gt; LongEvent)</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a
                            class="level is-mobile"
                            href="#Consumer-gt-LongEventHandler"
                            ><span class="level-left"
                              ><span class="level-item">7.2</span
                              ><span class="level-item"
                                >Consumer ( -&gt; LongEventHandler)</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a
                            class="level is-mobile"
                            href="#SofaTracerSpanEventFactory-（-gt-LongEventFactory）"
                            ><span class="level-left"
                              ><span class="level-item">7.3</span
                              ><span class="level-item"
                                >SofaTracerSpanEventFactory （-&gt;
                                LongEventFactory）</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a
                            class="level is-mobile"
                            href="#ConsumerThreadFactory-gt-LongEventThreadFactory"
                            ><span class="level-left"
                              ><span class="level-item">7.4</span
                              ><span class="level-item"
                                >ConsumerThreadFactory (-&gt;
                                LongEventThreadFactory )</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#构建disruptor"
                            ><span class="level-left"
                              ><span class="level-item">7.5</span
                              ><span class="level-item"
                                >构建disruptor</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#启动-disruptor"
                            ><span class="level-left"
                              ><span class="level-item">7.6</span
                              ><span class="level-item"
                                >启动 disruptor</span
                              ></span
                            ></a
                          >
                        </li>
                        <li>
                          <a class="level is-mobile" href="#发布事件"
                            ><span class="level-left"
                              ><span class="level-item">7.7</span
                              ><span class="level-item">发布事件</span></span
                            ></a
                          >
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a class="level is-mobile" href="#小结"
                        ><span class="level-left"
                          ><span class="level-item">8</span
                          ><span class="level-item">小结</span></span
                        ></a
                      >
                    </li>
                  </ul>
                </div>
              </div>
              <script src="/js/toc.js" defer></script>
            </div>
            <div class="card widget" data-type="tags">
              <div class="card-content">
                <div class="menu">
                  <h3 class="menu-label">标签</h3>
                  <div class="field is-grouped is-grouped-multiline">
                    <div class="control">
                      <a class="tags has-addons" href="/tags/BeanDefinition/"
                        ><span class="tag">BeanDefinition</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/BeanPostProcessor/"
                        ><span class="tag">BeanPostProcessor</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/BeanWrapper/"
                        ><span class="tag">BeanWrapper</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/CAS/"
                        ><span class="tag">CAS</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/ClassLoader/"
                        ><span class="tag">ClassLoader</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/CopyOnWriteArraySet/"
                        ><span class="tag">CopyOnWriteArraySet</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Disruptor/"
                        ><span class="tag">Disruptor</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Embedded-Tomcat/"
                        ><span class="tag">Embedded Tomcat</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Exception/"
                        ><span class="tag">Exception</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Executor/"
                        ><span class="tag">Executor</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/FX-Application/"
                        ><span class="tag">FX Application</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/FatJar/"
                        ><span class="tag">FatJar</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Ioc/"
                        ><span class="tag">Ioc</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/JAR/"
                        ><span class="tag">JAR</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/JDK/"
                        ><span class="tag">JDK</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/JUC/"
                        ><span class="tag">JUC</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Kafka/"
                        ><span class="tag">Kafka</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/MANIFEST-MF/"
                        ><span class="tag">MANIFEST.MF</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Mockito/"
                        ><span class="tag">Mockito</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Mysql/"
                        ><span class="tag">Mysql</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/OOM/"
                        ><span class="tag">OOM</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/OpenTracing/"
                        ><span class="tag">OpenTracing</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/PropertySource/"
                        ><span class="tag">PropertySource</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Readiness-Check/"
                        ><span class="tag">Readiness Check</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/ResourceLoader/"
                        ><span class="tag">ResourceLoader</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/RestTemplate/"
                        ><span class="tag">RestTemplate</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/RocketMQ/"
                        ><span class="tag">RocketMQ</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/SOFA/"
                        ><span class="tag">SOFA</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/SOFAArk/"
                        ><span class="tag">SOFAArk</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/SOFAStack/"
                        ><span class="tag">SOFAStack</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/SpringBoot/"
                        ><span class="tag">SpringBoot</span
                        ><span class="tag">16</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/TestDouble/"
                        ><span class="tag">TestDouble</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/ThreadPoolExecutor/"
                        ><span class="tag">ThreadPoolExecutor</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Tracer/"
                        ><span class="tag">Tracer</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/Zipkin/"
                        ><span class="tag">Zipkin</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/ab-test/"
                        ><span class="tag">ab test</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/actuator/"
                        ><span class="tag">actuator</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/aop/"
                        ><span class="tag">aop</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/api/"
                        ><span class="tag">api</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/apollo/"
                        ><span class="tag">apollo</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/bean-%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6/"
                        ><span class="tag">bean 扩展机制</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"
                        ><span class="tag">bean 生命周期</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/bootstrap/"
                        ><span class="tag">bootstrap</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/cache/"
                        ><span class="tag">cache</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/classloader/"
                        ><span class="tag">classloader</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/config/"
                        ><span class="tag">config</span
                        ><span class="tag">6</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/cookie/"
                        ><span class="tag">cookie</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/curator/"
                        ><span class="tag">curator</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/docker/"
                        ><span class="tag">docker</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/eureka/"
                        ><span class="tag">eureka</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/event/"
                        ><span class="tag">event</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/feign/"
                        ><span class="tag">feign</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/gateway/"
                        ><span class="tag">gateway</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/gc/"
                        ><span class="tag">gc</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/git/"
                        ><span class="tag">git</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/github/"
                        ><span class="tag">github</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/guava/"
                        ><span class="tag">guava</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/http/"
                        ><span class="tag">http</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/hystrix/"
                        ><span class="tag">hystrix</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/java/"
                        ><span class="tag">java</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/junit/"
                        ><span class="tag">junit</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/jvm/"
                        ><span class="tag">jvm</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/kafka/"
                        ><span class="tag">kafka</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/linux/"
                        ><span class="tag">linux</span
                        ><span class="tag">6</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/lock/"
                        ><span class="tag">lock</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/log/"
                        ><span class="tag">log</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/logback/"
                        ><span class="tag">logback</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/maven/"
                        ><span class="tag">maven</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/maven-debug/"
                        ><span class="tag">maven debug</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/maven-plugin/"
                        ><span class="tag">maven plugin</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/merge/"
                        ><span class="tag">merge</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/microservices/"
                        ><span class="tag">microservices</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/mock/"
                        ><span class="tag">mock</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/mybatis/"
                        ><span class="tag">mybatis</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/mysql/"
                        ><span class="tag">mysql</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/nacos/"
                        ><span class="tag">nacos</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/namespace/"
                        ><span class="tag">namespace</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/netflix/"
                        ><span class="tag">netflix</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/nginx/"
                        ><span class="tag">nginx</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/oop-klass/"
                        ><span class="tag">oop-klass</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/reactor/"
                        ><span class="tag">reactor</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/rebase/"
                        ><span class="tag">rebase</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/redis/"
                        ><span class="tag">redis</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/rpc/"
                        ><span class="tag">rpc</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/session/"
                        ><span class="tag">session</span
                        ><span class="tag">6</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/set/"
                        ><span class="tag">set</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/shell/"
                        ><span class="tag">shell</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/slf4j/"
                        ><span class="tag">slf4j</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/spring/"
                        ><span class="tag">spring</span
                        ><span class="tag">11</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/spring-cloud/"
                        ><span class="tag">spring cloud</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/spring-mvc/"
                        ><span class="tag">spring mvc</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/spring-%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6/"
                        ><span class="tag">spring 扩展机制</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/sql/"
                        ><span class="tag">sql</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/ssh/"
                        ><span class="tag">ssh</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/starter-%E6%9C%BA%E5%88%B6/"
                        ><span class="tag">starter 机制</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/test/"
                        ><span class="tag">test</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/testing/"
                        ><span class="tag">testing</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/thread/"
                        ><span class="tag">thread</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/tomcat/"
                        ><span class="tag">tomcat</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/top/"
                        ><span class="tag">top</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/typecheck/"
                        ><span class="tag">typecheck</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/yapi/"
                        ><span class="tag">yapi</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/yum/"
                        ><span class="tag">yum</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a class="tags has-addons" href="/tags/zookeeper/"
                        ><span class="tag">zookeeper</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E4%B8%AD%E5%8F%B0/"
                        ><span class="tag">中台</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/"
                        ><span class="tag">事件机制</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/"
                        ><span class="tag">依赖注入</span
                        ><span class="tag">3</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"
                        ><span class="tag">分布式</span
                        ><span class="tag">6</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/"
                        ><span class="tag">分布式链路跟踪</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"
                        ><span class="tag">反向代理</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%8F%8D%E5%B0%84/"
                        ><span class="tag">反射</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%90%88%E8%82%A5/"
                        ><span class="tag">合肥</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"
                        ><span class="tag">并发编程</span
                        ><span class="tag">5</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"
                        ><span class="tag">微服务</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%9D%AD%E5%B7%9E/"
                        ><span class="tag">杭州</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%9E%B6%E6%9E%84/"
                        ><span class="tag">架构</span
                        ><span class="tag">4</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%A1%86%E6%9E%B6/"
                        ><span class="tag">框架</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%B3%9B%E5%9E%8B/"
                        ><span class="tag">泛型</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"
                        ><span class="tag">注册中心</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E6%B6%88%E6%81%AF/"
                        ><span class="tag">消息</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"
                        ><span class="tag">类加载</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"
                        ><span class="tag">线程池</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"
                        ><span class="tag">自动配置</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"
                        ><span class="tag">负载均衡</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E8%BF%90%E7%BB%B4/"
                        ><span class="tag">运维</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8/"
                        ><span class="tag">迭代器</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E9%85%8D%E7%BD%AE/"
                        ><span class="tag">配置</span
                        ><span class="tag">2</span></a
                      >
                    </div>
                    <div class="control">
                      <a
                        class="tags has-addons"
                        href="/tags/%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BB/"
                        ><span class="tag">集群选主</span
                        ><span class="tag">1</span></a
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div
              class="column-right-shadow is-hidden-widescreen is-sticky"
            ></div>
          </div>
        </div>
      </div>
    </section>
    <footer class="footer">
      <div class="container">
        <div class="level">
          <div class="level-start">
            <a class="footer-logo is-block mb-2" href="/">J.Queue的技术博客</a>
            <p class="is-size-7">
              <span>&copy; 2022 J.Queue</span>  Powered by
              <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a
              > &amp; <a
                href="https://github.com/ppoffice/hexo-theme-icarus"
                target="_blank"
                rel="noopener"
                >Icarus</a
              ><br /><span id="busuanzi_container_site_uv"
                >共<span id="busuanzi_value_site_uv">0</span>个访客</span
              >
            </p>
          </div>
          <div class="level-end">
            <div class="field has-addons">
              <p class="control">
                <a
                  class="button is-transparent is-large"
                  target="_blank"
                  rel="noopener"
                  title="Download on GitHub"
                  href="https://github.com/glmapper"
                  ><i class="fab fa-github"></i
                ></a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
    <script>
      moment.locale('zh-CN')
    </script>
    <script>
      var IcarusThemeSettings = {
        article: {
          highlight: {
            clipboard: false,
            fold: '',
          },
        },
      }
    </script>
    <script src="/js/column.js"></script>
    <script src="/js/animation.js"></script>
    <a id="back-to-top" title="回到顶端" href="javascript:;"
      ><i class="fas fa-chevron-up"></i
    ></a>
    <script src="/js/back_to_top.js" defer></script>
    <!--!--><!--!--><!--!--><!--!-->
    <script
      src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js"
      defer
    ></script>
    <script>
      window.addEventListener('load', () => {
        window.cookieconsent.initialise({
          type: 'info',
          theme: 'edgeless',
          static: false,
          position: 'bottom-left',
          content: {
            message: '此网站使用Cookie来改善您的体验。',
            dismiss: '知道了！',
            allow: '允许使用Cookie',
            deny: '拒绝',
            link: '了解更多',
            policy: 'Cookie政策',
            href: 'https://www.cookiesandyou.com/',
          },
          palette: {
            popup: {
              background: '#edeff5',
              text: '#838391',
            },
            button: {
              background: '#4b81e8',
            },
          },
        })
      })
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"
      defer
    ></script>
    <script>
      window.addEventListener('load', () => {
        if (typeof $.fn.lightGallery === 'function') {
          $('.article').lightGallery({ selector: '.gallery-item' })
        }
        if (typeof $.fn.justifiedGallery === 'function') {
          if ($('.justified-gallery > p > .gallery-item').length) {
            $('.justified-gallery > p > .gallery-item').unwrap()
          }
          $('.justified-gallery').justifiedGallery()
        }
      })
    </script>
    <!--!--><!--!--><!--!--><!--!--><!--!-->
    <script src="/js/main.js" defer></script>
    <div class="searchbox">
      <div class="searchbox-container">
        <div class="searchbox-header">
          <div class="searchbox-input-container">
            <input
              class="searchbox-input"
              type="text"
              placeholder="想要查找什么..."
            />
          </div>
          <a class="searchbox-close" href="javascript:;">×</a>
        </div>
        <div class="searchbox-body"></div>
      </div>
    </div>
    <script src="/js/insight.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        loadInsight(
          { contentUrl: '/content.json' },
          {
            hint: '想要查找什么...',
            untitled: '(无标题)',
            posts: '文章',
            pages: '页面',
            categories: '分类',
            tags: '标签',
          }
        )
      })
    </script>
  </body>
</html>
