<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析 - 磊叔的技术博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="磊叔的技术博客"><meta name="msapplication-TileImage" content="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="磊叔的技术博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="对于一个 SpringBoot web 工程来说，一个主要的依赖标志就是有 spring-boot-starter-web 这个 starter ，spring-boot-starter-web 模块在 spring boot 中其实并没有代码存在，只是在 pom.xml 中携带了一些依赖，包括 web、webmvc、tomcat 等："><meta property="og:type" content="blog"><meta property="og:title" content="SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析"><meta property="og:url" content="http://www.glmapper.com/2019/10/06/springboot/springboot-series-server-tomcat/"><meta property="og:site_name" content="磊叔的技术博客"><meta property="og:description" content="对于一个 SpringBoot web 工程来说，一个主要的依赖标志就是有 spring-boot-starter-web 这个 starter ，spring-boot-starter-web 模块在 spring boot 中其实并没有代码存在，只是在 pom.xml 中携带了一些依赖，包括 web、webmvc、tomcat 等："><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-one.jpg"><meta property="article:published_time" content="2019-10-06T09:48:43.000Z"><meta property="article:modified_time" content="2022-04-23T09:52:15.406Z"><meta property="article:author" content="卫恒"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="tomcat"><meta property="article:tag" content="Embedded Tomcat"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-one.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.glmapper.com/2019/10/06/springboot/springboot-series-server-tomcat/"},"headline":"SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析","image":["https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-one.jpg"],"datePublished":"2019-10-06T09:48:43.000Z","dateModified":"2022-04-23T09:52:15.406Z","author":{"@type":"Person","name":"卫恒"},"publisher":{"@type":"Organization","name":"磊叔的技术博客","logo":{"@type":"ImageObject","url":{"text":"磊叔的技术博客"}}},"description":"对于一个 SpringBoot web 工程来说，一个主要的依赖标志就是有 spring-boot-starter-web 这个 starter ，spring-boot-starter-web 模块在 spring boot 中其实并没有代码存在，只是在 pom.xml 中携带了一些依赖，包括 web、webmvc、tomcat 等："}</script><link rel="canonical" href="http://www.glmapper.com/2019/10/06/springboot/springboot-series-server-tomcat/"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/github.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="磊叔的技术博客" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">磊叔的技术博客</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/glmapper"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-one.jpg" alt="SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-10-06T09:48:43.000Z" title="2019/10/6 下午5:48:43">2019-10-06</time>发表</span><span class="level-item"><time dateTime="2022-04-23T09:52:15.406Z" title="2022/4/23 下午5:52:15">2022-04-23</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/SpringBoot/">SpringBoot</a></span><span class="level-item">22 分钟读完 (大约3320个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析</h1><div class="content"><p>对于一个 SpringBoot web 工程来说，一个主要的依赖标志就是有 spring-boot-starter-web 这个 starter ，spring-boot-starter-web 模块在 spring boot 中其实并没有代码存在，只是在 pom.xml 中携带了一些依赖，包括 web、webmvc、tomcat 等：</p>
<span id="more"></span>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Spring Boot 默认的 web 服务容器是 tomcat ，如果想使用 Jetty 等来替换 Tomcat ，可以自行参考官方文档来解决。</p>
</blockquote>
<p>web、webmvc、tomcat 等提供了 web 应用的运行环境，那 spring-boot-starter 则是让这些运行环境工作的开关（因为 spring-boot-starter 中会间接引入 spring-boot-autoconfigure ）。</p>
<h2 id="WebServer-自动配置"><a href="#WebServer-自动配置" class="headerlink" title="WebServer 自动配置"></a>WebServer 自动配置</h2><p>在 spring-boot-autoconfigure 模块中，有处理关于 WebServer 的自动配置类 ServletWebServerFactoryAutoConfiguration 。</p>
<h3 id="ServletWebServerFactoryAutoConfiguration"><a href="#ServletWebServerFactoryAutoConfiguration" class="headerlink" title="ServletWebServerFactoryAutoConfiguration"></a>ServletWebServerFactoryAutoConfiguration</h3><p>代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ServletRequest.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedJetty.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedUndertow.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletWebServerFactoryAutoConfiguration</span></span><br></pre></td></tr></table></figure>
<br />

<p>两个 Condition 表示当前运行环境是基于 servlet 标准规范的 web 服务：</p>
<ul>
<li>ConditionalOnClass(ServletRequest.class) ： 表示当前必须有 servlet-api 依赖存在</li>
<li>ConditionalOnWebApplication(type &#x3D; Type.SERVLET) ：仅基于servlet的Web应用程序</li>
</ul>
<p>@EnableConfigurationProperties(ServerProperties.class)：ServerProperties 配置中包括了常见的 server.port 等配置属性。</p>
<p>通过 <a href="#">@Import</a> 导入嵌入式容器相关的自动配置类，有 EmbeddedTomcat、EmbeddedJetty 和EmbeddedUndertow。</p>
<p><strong>综合来看，ServletWebServerFactoryAutoConfiguration 自动配置类中主要做了以下几件事情：</strong></p>
<ul>
<li>导入了内部类 BeanPostProcessorsRegistrar，它实现了 ImportBeanDefinitionRegistrar，可以实现ImportBeanDefinitionRegistrar 来注册额外的 BeanDefinition。</li>
<li>导入了 ServletWebServerFactoryConfiguration.EmbeddedTomcat 等嵌入容器先关配置（我们主要关注tomcat 相关的配置）。</li>
<li>注册了ServletWebServerFactoryCustomizer、TomcatServletWebServerFactoryCustomizer 两个WebServerFactoryCustomizer 类型的 bean。</li>
</ul>
<p>下面就针对这几个点，做下详细的分析。</p>
<h3 id="BeanPostProcessorsRegistrar"><a href="#BeanPostProcessorsRegistrar" class="headerlink" title="BeanPostProcessorsRegistrar"></a>BeanPostProcessorsRegistrar</h3><p>BeanPostProcessorsRegistrar 这个内部类的代码如下(省略了部分代码)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BeanPostProcessorsRegistrar</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, BeanFactoryAware &#123;</span><br><span class="line">    <span class="comment">// 省略代码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span><br><span class="line"><span class="params">                                        BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.beanFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册 WebServerFactoryCustomizerBeanPostProcessor</span></span><br><span class="line">        registerSyntheticBeanIfMissing(registry,</span><br><span class="line">                                       <span class="string">&quot;webServerFactoryCustomizerBeanPostProcessor&quot;</span>,</span><br><span class="line">                                       WebServerFactoryCustomizerBeanPostProcessor.class);</span><br><span class="line">        <span class="comment">// 注册 errorPageRegistrarBeanPostProcessor</span></span><br><span class="line">        registerSyntheticBeanIfMissing(registry,</span><br><span class="line">                                       <span class="string">&quot;errorPageRegistrarBeanPostProcessor&quot;</span>,</span><br><span class="line">                                       ErrorPageRegistrarBeanPostProcessor.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码中，注册了两个 bean，一个 WebServerFactoryCustomizerBeanPostProcessor，一个 errorPageRegistrarBeanPostProcessor；这两个都实现类 BeanPostProcessor 接口，属于 bean 的后置处理器，作用是在 bean 初始化前后加一些自己的逻辑处理。</p>
<ul>
<li>WebServerFactoryCustomizerBeanPostProcessor：作用是在 WebServerFactory 初始化时调用上面自动配置类注入的那些 WebServerFactoryCustomizer ，然后调用 WebServerFactoryCustomizer 中的 customize 方法来 处理 WebServerFactory。</li>
<li>errorPageRegistrarBeanPostProcessor：和上面的作用差不多，不过这个是处理 ErrorPageRegistrar 的。</li>
</ul>
<p>下面简单看下 WebServerFactoryCustomizerBeanPostProcessor 中的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebServerFactoryCustomizerBeanPostProcessor</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span>, BeanFactoryAware &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在 postProcessBeforeInitialization 方法中，如果当前 bean 是 WebServerFactory，则进行</span></span><br><span class="line">    <span class="comment">// 一些后置处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span></span><br><span class="line">			<span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> WebServerFactory) &#123;</span><br><span class="line">			postProcessBeforeInitialization((WebServerFactory) bean);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 这段代码就是拿到所有的 Customizers ，然后遍历调用这些 Customizers 的 customize 方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postProcessBeforeInitialization</span><span class="params">(WebServerFactory webServerFactory)</span> &#123;</span><br><span class="line">		LambdaSafe</span><br><span class="line">				.callbacks(WebServerFactoryCustomizer.class, getCustomizers(),</span><br><span class="line">						webServerFactory)</span><br><span class="line">				.withLogger(WebServerFactoryCustomizerBeanPostProcessor.class)</span><br><span class="line">				.invoke((customizer) -&gt; customizer.customize(webServerFactory));</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自动配置类中注册的两个-Customizer-Bean"><a href="#自动配置类中注册的两个-Customizer-Bean" class="headerlink" title="自动配置类中注册的两个 Customizer Bean"></a>自动配置类中注册的两个 Customizer Bean</h2><p>这两个 Customizer 实际上就是去处理一些配置值，然后绑定到 各自的工厂类的。</p>
<h3 id="WebServerFactoryCustomizer"><a href="#WebServerFactoryCustomizer" class="headerlink" title="WebServerFactoryCustomizer"></a>WebServerFactoryCustomizer</h3><p>将 serverProperties 配置值绑定给 ConfigurableServletWebServerFactory 对象实例上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(ConfigurableServletWebServerFactory factory)</span> &#123;</span><br><span class="line">    <span class="type">PropertyMapper</span> <span class="variable">map</span> <span class="operator">=</span> PropertyMapper.get().alwaysApplyingWhenNonNull();</span><br><span class="line">    <span class="comment">// 端口</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getPort).to(factory::setPort);</span><br><span class="line">    <span class="comment">// address</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getAddress).to(factory::setAddress);</span><br><span class="line">    <span class="comment">// contextPath</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties.getServlet()::getContextPath)</span><br><span class="line">        .to(factory::setContextPath);</span><br><span class="line">    <span class="comment">// displayName</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties.getServlet()::getApplicationDisplayName)</span><br><span class="line">        .to(factory::setDisplayName);</span><br><span class="line">    <span class="comment">// session 配置</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties.getServlet()::getSession).to(factory::setSession);</span><br><span class="line">    <span class="comment">// ssl</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getSsl).to(factory::setSsl);</span><br><span class="line">    <span class="comment">// jsp</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties.getServlet()::getJsp).to(factory::setJsp);</span><br><span class="line">    <span class="comment">// 压缩配置策略实现</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getCompression).to(factory::setCompression);</span><br><span class="line">    <span class="comment">// http2 </span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getHttp2).to(factory::setHttp2);</span><br><span class="line">    <span class="comment">// serverHeader</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties::getServerHeader).to(factory::setServerHeader);</span><br><span class="line">    <span class="comment">// contextParameters</span></span><br><span class="line">    map.from(<span class="built_in">this</span>.serverProperties.getServlet()::getContextParameters)</span><br><span class="line">        .to(factory::setInitParameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TomcatServletWebServerFactoryCustomizer"><a href="#TomcatServletWebServerFactoryCustomizer" class="headerlink" title="TomcatServletWebServerFactoryCustomizer"></a>TomcatServletWebServerFactoryCustomizer</h3><p>相比于上面那个，这个 customizer 主要处理 Tomcat 相关的配置值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(TomcatServletWebServerFactory factory)</span> &#123;</span><br><span class="line">    <span class="comment">// 拿到 tomcat 相关的配置</span></span><br><span class="line">    ServerProperties.<span class="type">Tomcat</span> <span class="variable">tomcatProperties</span> <span class="operator">=</span> <span class="built_in">this</span>.serverProperties.getTomcat();</span><br><span class="line">    <span class="comment">// server.tomcat.additional-tld-skip-patterns</span></span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(tomcatProperties.getAdditionalTldSkipPatterns())) &#123;</span><br><span class="line">        factory.getTldSkipPatterns()</span><br><span class="line">            .addAll(tomcatProperties.getAdditionalTldSkipPatterns());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// server.redirectContextRoot</span></span><br><span class="line">    <span class="keyword">if</span> (tomcatProperties.getRedirectContextRoot() != <span class="literal">null</span>) &#123;</span><br><span class="line">        customizeRedirectContextRoot(factory,</span><br><span class="line">                                     tomcatProperties.getRedirectContextRoot());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// server.useRelativeRedirects</span></span><br><span class="line">    <span class="keyword">if</span> (tomcatProperties.getUseRelativeRedirects() != <span class="literal">null</span>) &#123;</span><br><span class="line">        customizeUseRelativeRedirects(factory,</span><br><span class="line">                                      tomcatProperties.getUseRelativeRedirects());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebServerFactory"><a href="#WebServerFactory" class="headerlink" title="WebServerFactory"></a>WebServerFactory</h2><p>用于创建 WebServer 的工厂的标记接口。</p>
<h3 id="类体系结构"><a href="#类体系结构" class="headerlink" title="类体系结构"></a>类体系结构</h3><p><img src="https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-one.jpg"></p>
<p>上图为 WebServerFactory -&gt; TomcatServletWebServerFactory 的整个类结构关系。</p>
<h3 id="TomcatServletWebServerFactory"><a href="#TomcatServletWebServerFactory" class="headerlink" title="TomcatServletWebServerFactory"></a>TomcatServletWebServerFactory</h3><p>TomcatServletWebServerFactory 是用于获取 Tomcat 作为 WebServer 的工厂类实现，其中最核心的方法就是 getWebServer，获取一个 WebServer 对象实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WebServer <span class="title function_">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个 Tomcat 实例</span></span><br><span class="line">    <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">    <span class="comment">// 创建一个 Tomcat 实例工作空间目录</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">baseDir</span> <span class="operator">=</span> (<span class="built_in">this</span>.baseDirectory != <span class="literal">null</span>) ? <span class="built_in">this</span>.baseDirectory</span><br><span class="line">        : createTempDir(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">    <span class="comment">// 创建连接对象</span></span><br><span class="line">    <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connector</span>(<span class="built_in">this</span>.protocol);</span><br><span class="line">    tomcat.getService().addConnector(connector);</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    customizeConnector(connector);</span><br><span class="line">    tomcat.setConnector(connector);</span><br><span class="line">    tomcat.getHost().setAutoDeploy(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 配置 Engine，没有什么实质性的操作，可忽略</span></span><br><span class="line">    configureEngine(tomcat.getEngine());</span><br><span class="line">    <span class="comment">// 一些附加链接，默认是 0 个</span></span><br><span class="line">    <span class="keyword">for</span> (Connector additionalConnector : <span class="built_in">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">        tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">    <span class="comment">// 返回 webServer</span></span><br><span class="line">    <span class="keyword">return</span> getTomcatWebServer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>1、customizeConnector ： 给 Connector 设置 port、protocolHandler、uriEncoding 等。Connector 构造的逻辑主要是在NIO和APR选择中选择一个协议，然后反射创建实例并强转为 ProtocolHandler</li>
<li>2、prepareContext 这里并不是说准备当前 Tomcat 运行环境的上下文信息，而是准备一个 StandardContext ，也就是准备一个 web app。</li>
</ul>
<h3 id="准备-Web-App-Context-容器"><a href="#准备-Web-App-Context-容器" class="headerlink" title="准备 Web App Context 容器"></a>准备 Web App Context 容器</h3><p>对于 Tomcat 来说，每个 context 就是映射到 一个 web app 的，所以 prepareContext 做的事情就是将 web 应用映射到一个 TomcatEmbeddedContext ，然后加入到 Host 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(Host host, ServletContextInitializer[] initializers)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">documentRoot</span> <span class="operator">=</span> getValidDocumentRoot();</span><br><span class="line">    <span class="comment">// 创建一个 TomcatEmbeddedContext 对象</span></span><br><span class="line">    <span class="type">TomcatEmbeddedContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatEmbeddedContext</span>();</span><br><span class="line">    <span class="keyword">if</span> (documentRoot != <span class="literal">null</span>) &#123;</span><br><span class="line">        context.setResources(<span class="keyword">new</span> <span class="title class_">LoaderHidingResourceRoot</span>(context));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置描述此容器的名称字符串。在属于特定父项的子容器集内，容器名称必须唯一。</span></span><br><span class="line">    context.setName(getContextPath());</span><br><span class="line">    <span class="comment">// 设置此Web应用程序的显示名称。</span></span><br><span class="line">    context.setDisplayName(getDisplayName());</span><br><span class="line">    <span class="comment">// 设置 webContextPath  默认是   /</span></span><br><span class="line">    context.setPath(getContextPath());</span><br><span class="line">    <span class="type">File</span> <span class="variable">docBase</span> <span class="operator">=</span> (documentRoot != <span class="literal">null</span>) ? documentRoot</span><br><span class="line">        : createTempDir(<span class="string">&quot;tomcat-docbase&quot;</span>);</span><br><span class="line">    context.setDocBase(docBase.getAbsolutePath());</span><br><span class="line">    <span class="comment">// 注册一个FixContextListener监听，这个监听用于设置context的配置状态以及是否加入登录验证的逻辑</span></span><br><span class="line">    context.addLifecycleListener(<span class="keyword">new</span> <span class="title class_">FixContextListener</span>());</span><br><span class="line">    <span class="comment">// 设置 父 ClassLoader</span></span><br><span class="line">    context.setParentClassLoader(</span><br><span class="line">        (<span class="built_in">this</span>.resourceLoader != <span class="literal">null</span>) ? <span class="built_in">this</span>.resourceLoader.getClassLoader()</span><br><span class="line">        : ClassUtils.getDefaultClassLoader());</span><br><span class="line">    <span class="comment">// 覆盖Tomcat的默认语言环境映射以与其他服务器对齐。</span></span><br><span class="line">    resetDefaultLocaleMapping(context);</span><br><span class="line">    <span class="comment">// 添加区域设置编码映射（请参阅Servlet规范2.4的5.4节）</span></span><br><span class="line">    addLocaleMappings(context);</span><br><span class="line">    <span class="comment">// 设置是否使用相对地址重定向</span></span><br><span class="line">    context.setUseRelativeRedirects(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        context.setCreateUploadTargets(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NoSuchMethodError ex) &#123;</span><br><span class="line">        <span class="comment">// Tomcat is &lt; 8.5.39. Continue.</span></span><br><span class="line">    &#125;</span><br><span class="line">    configureTldSkipPatterns(context);</span><br><span class="line">    <span class="comment">// 设置 WebappLoader ，并且将 父 classLoader 作为构建参数</span></span><br><span class="line">    <span class="type">WebappLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebappLoader</span>(context.getParentClassLoader());</span><br><span class="line">    <span class="comment">// 设置 WebappLoader 的 loaderClass 值</span></span><br><span class="line">    loader.setLoaderClass(TomcatEmbeddedWebappClassLoader.class.getName());</span><br><span class="line">    <span class="comment">// 会将加载类向上委托</span></span><br><span class="line">    loader.setDelegate(<span class="literal">true</span>);</span><br><span class="line">    context.setLoader(loader);</span><br><span class="line">    <span class="keyword">if</span> (isRegisterDefaultServlet()) &#123;</span><br><span class="line">        addDefaultServlet(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 是否注册 jspServlet</span></span><br><span class="line">    <span class="keyword">if</span> (shouldRegisterJspServlet()) &#123;</span><br><span class="line">        addJspServlet(context);</span><br><span class="line">        addJasperInitializer(context);</span><br><span class="line">    &#125;</span><br><span class="line">    context.addLifecycleListener(<span class="keyword">new</span> <span class="title class_">StaticResourceConfigurer</span>(context));</span><br><span class="line">    ServletContextInitializer[] initializersToUse = mergeInitializers(initializers);</span><br><span class="line">    <span class="comment">// 在 host 中 加入一个 context 容器</span></span><br><span class="line">    <span class="comment">// add时给context注册了个内存泄漏跟踪的监听MemoryLeakTrackingListener,详见 addChild 方法</span></span><br><span class="line">    host.addChild(context);</span><br><span class="line">    <span class="comment">//对context做了些设置工作，包括TomcatStarter(实例化并set给context),</span></span><br><span class="line">    <span class="comment">// LifecycleListener,contextValue,errorpage,Mime,session超时持久化等以及一些自定义工作</span></span><br><span class="line">    configureContext(context, initializersToUse);</span><br><span class="line">    <span class="comment">// postProcessContext 方法是空的，留给子类重写用的</span></span><br><span class="line">    postProcessContext(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看下，WebappLoader 可以通过 setLoaderClass 和 getLoaderClass 这两个方法可以更改loaderClass 的值。所以也就意味着，我们可以自己定义一个继承 webappClassLoader 的类，来更换系统自带的默认实现。</p>
<h3 id="初始化-TomcatWebServer"><a href="#初始化-TomcatWebServer" class="headerlink" title="初始化 TomcatWebServer"></a>初始化 TomcatWebServer</h3><p>在 getWebServer 方法的最后就是构建一个 TomcatWebServer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory</span></span><br><span class="line"><span class="keyword">protected</span> TomcatWebServer <span class="title function_">getTomcatWebServer</span><span class="params">(Tomcat tomcat)</span> &#123;</span><br><span class="line">    <span class="comment">// new 一个 TomcatWebServer</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatWebServer</span>(tomcat, getPort() &gt;= <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.boot.web.embedded.tomcat.TomcatWebServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TomcatWebServer</span><span class="params">(Tomcat tomcat, <span class="type">boolean</span> autoStart)</span> &#123;</span><br><span class="line">    Assert.notNull(tomcat, <span class="string">&quot;Tomcat Server must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.tomcat = tomcat;</span><br><span class="line">    <span class="built_in">this</span>.autoStart = autoStart;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要是 initialize 这个方法，这个方法中将会启动 tomcat 服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Tomcat initialized with port(s): &quot;</span> + getPortsDescription(<span class="literal">false</span>));</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.monitor) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 对全局原子变量 containerCounter+1，由于初始值是-1，</span></span><br><span class="line">    <span class="comment">// 所以 addInstanceIdToEngineName 方法内后续的获取引擎并设置名字的逻辑不会执行</span></span><br><span class="line">            addInstanceIdToEngineName();</span><br><span class="line">			<span class="comment">// 获取 Context </span></span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> findContext();</span><br><span class="line">            <span class="comment">// 给 Context 对象实例生命周期监听器</span></span><br><span class="line">            context.addLifecycleListener((event) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (context.equals(event.getSource())</span><br><span class="line">                    &amp;&amp; Lifecycle.START_EVENT.equals(event.getType())) &#123;</span><br><span class="line">                    <span class="comment">// 将上面new的connection以service（这里是StandardService[Tomcat]）做key保存到</span></span><br><span class="line">                    <span class="comment">// serviceConnectors中，并将 StandardService 中的connectors 与 service 解绑(connector.setService((Service)null);)，</span></span><br><span class="line">                    <span class="comment">// 解绑后下面利用LifecycleBase启动容器就不会启动到Connector了</span></span><br><span class="line">                    removeServiceConnectors();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 启动服务器以触发初始化监听器</span></span><br><span class="line">            <span class="built_in">this</span>.tomcat.start();</span><br><span class="line">            <span class="comment">// 这个方法检查初始化过程中的异常，如果有直接在主线程抛出，</span></span><br><span class="line">            <span class="comment">// 检查方法是TomcatStarter中的 startUpException，这个值是在 Context 启动过程中记录的</span></span><br><span class="line">            rethrowDeferredStartupExceptions();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 绑定命名的上下文和classloader，</span></span><br><span class="line">                ContextBindings.bindClassLoader(context, context.getNamingToken(),</span><br><span class="line">                                                getClass().getClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">                <span class="comment">// 设置失败不需要关心</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ：与Jetty不同，Tomcat所有的线程都是守护线程，所以创建一个非守护线程</span></span><br><span class="line">            <span class="comment">// （例：Thread[container-0,5,main]）来避免服务到这就shutdown了</span></span><br><span class="line">            startDaemonAwaitThread();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            stopSilently();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WebServerException</span>(<span class="string">&quot;Unable to start embedded Tomcat&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查找 Context ，实际上就是查找一个Tomcat 中的一个 web 应用，SpringBoot 中默认启动一个 Tomcat ，并且一个 Tomcat 中只有一个 Web 应用（FATJAR 模式下，应用与 Tomcat 是 1：1 关系），所有在遍历 Host 下的 Container 时，如果 Container 类型是 Context ，就直接返回了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Context <span class="title function_">findContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Container child : <span class="built_in">this</span>.tomcat.getHost().findChildren()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Context) child;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The host does not contain a Context&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Tomcat-启动过程"><a href="#Tomcat-启动过程" class="headerlink" title="Tomcat 启动过程"></a>Tomcat 启动过程</h2><p>在 TomcatWebServer 的 initialize 方法中会执行 tomcat 的启动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start the server to trigger initialization listeners</span></span><br><span class="line"><span class="built_in">this</span>.tomcat.start();</span><br></pre></td></tr></table></figure>

<p>org.apache.catalina.startup.Tomcat 的 start 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="comment">// 初始化 server</span></span><br><span class="line">    getServer();</span><br><span class="line">    <span class="comment">// 启动 server</span></span><br><span class="line">    server.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化-Server"><a href="#初始化-Server" class="headerlink" title="初始化 Server"></a>初始化 Server</h3><p>初始化 server 实际上就是构建一个 StandardServer 对象实例，关于 Tomcat 中的 Server 可以参考附件中的说明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">getServer</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 如果已经存在的话就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 设置系统属性 catalina.useNaming</span></span><br><span class="line">    System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">	<span class="comment">// 直接 new 一个 StandardServer</span></span><br><span class="line">    server = <span class="keyword">new</span> <span class="title class_">StandardServer</span>();</span><br><span class="line">	<span class="comment">// 初始化 baseDir （catalina.base、catalina.home、 ~/tomcat.&#123;port&#125;）</span></span><br><span class="line">    initBaseDir();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set configuration source</span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(<span class="keyword">new</span> <span class="title class_">File</span>(basedir), <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">    server.setPort( -<span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardService</span>();</span><br><span class="line">    service.setName(<span class="string">&quot;Tomcat&quot;</span>);</span><br><span class="line">    server.addService(service);</span><br><span class="line">    <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>上面对 SpringBoot 中内嵌 Tomcat 的过程做了分析，这个过程实际上并不复杂，就是在刷新 Spring 上下文的过程中将 Tomcat 容器启动起来，并且将当前应用绑定到一个 Context ，然后添加了 Host。下图是程序的执行堆栈和执行内嵌 Tomcat 初始化和启动的时机。</p>
<p><img src="https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/tomcat-boot-two.jpg"></p>
<p>下面总结下整个过程：</p>
<ul>
<li>通过自定配置注册相关的 Bean ，包括一些 Factory 和 后置处理器等</li>
<li>上下文刷新阶段，执行创建 WebServer，这里需要用到前一个阶段所注册的 Bean <ul>
<li>包括创建 ServletContext</li>
<li>实例化 webServer</li>
</ul>
</li>
<li>创建 Tomcat 实例、创建 Connector 连接器</li>
<li>绑定 应用到 ServletContext，并添加相关的生命周期范畴内的监听器，然后将 Context 添加到 host 中</li>
<li>实例化 webServer 并且启动 Tomcat 服务</li>
</ul>
<p>SpringBoot 的 Fatjar 方式没有提供共享 Tomcat 的实现逻辑，就是两个 FATJAT 启动可以只实例化一个 Tomcat 实例（包括 Connector 和 Host ），从前面的分析知道，每个 web 应用（一个 FATJAT 对应的应用）实例上就是映射到一个 Context ；而对于 war 方式，一个 Host 下面是可以挂载多个 Context 的。</p>
<h1 id="附：Tomcat-组件说明"><a href="#附：Tomcat-组件说明" class="headerlink" title="附：Tomcat 组件说明"></a>附：Tomcat 组件说明</h1><table>
<thead>
<tr>
<th>组件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>表示整个Servlet 容器，因此 Tomcat 运行环境中只有唯一一个 Server 实例</td>
</tr>
<tr>
<td>Service</td>
<td>Service 表示一个或者多个 Connector 的集合，这些 Connector 共享同一个 Container 来处理其请求。在同一个 Tomcat 实例内可以包含任意多个 Service 实例，他们彼此独立。</td>
</tr>
<tr>
<td>Connector</td>
<td>Tomcat 连接器，用于监听和转化 Socket 请求，同时将读取的 Socket 请求交由 Container 处理，支持不同协议以及不同的 I&#x2F;O 方式。</td>
</tr>
<tr>
<td>Container</td>
<td>Container 表示能够执行客户端请求并返回响应的一类对象，在 Tomcat 中存在不同级别的容器：Engine、Host、Context、Wrapper</td>
</tr>
<tr>
<td>Engine</td>
<td>Engine 表示整个 Servlet 引擎。在 Tomcat 中，Engine 为最高层级的容器对象，虽然 Engine 不是直接处理请求的容器，确是获取目标容器的入口</td>
</tr>
<tr>
<td>Host</td>
<td>Host 作为一类容器，表示 Servlet 引擎（即Engine）中的虚拟机，与一个服务器的网络名有关，如域名等。客户端可以使用这个网络名连接服务器，这个名称必须要在 DNS 服务器上注册</td>
</tr>
<tr>
<td>Context</td>
<td>Context 作为一类容器，用于表示 ServletContext，在 Servlet 规范中，一个 ServletContext 即表示一个独立的 web 应用</td>
</tr>
<tr>
<td>Wrapper</td>
<td>Wrapper 作为一类容器，用于表示 Web 应用中定义的 Servlet</td>
</tr>
<tr>
<td>Executor</td>
<td>表示 Tomcat 组件间可以共享的线程池</td>
</tr>
</tbody></table>
</div><div class="article-licensing box"><div class="licensing-title"><p>SpringBoot 源码系列-内嵌 Tomcat 的实现原理解析</p><p><a href="http://www.glmapper.com/2019/10/06/springboot/springboot-series-server-tomcat/">http://www.glmapper.com/2019/10/06/springboot/springboot-series-server-tomcat/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>卫恒</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-10-06</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-04-23</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SpringBoot/">SpringBoot</a><a class="link-muted mr-2" rel="tag" href="/tags/tomcat/">tomcat</a><a class="link-muted mr-2" rel="tag" href="/tags/Embedded-Tomcat/">Embedded Tomcat</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/zfb.JPG" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/pay.JPG" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/10/13/springboot/springboot-series-fatjar/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SpringBoot 源码系列-FatJar 启动原理</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/08/28/sofa/sofa-ark-plugin-rule/"><span class="level-item">ARK 插件基本规则及注意事项</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "c08884312f385cbab20ddee3ad6f573e",
            repo: "glmapper.github.io",
            owner: "glmapper",
            clientID: "d25147ddf77e70d7adfe",
            clientSecret: "c10bbd1ba7a09c96e4106709107d4da85d60be78",
            admin: ["glmapper"],
            createIssueManually: false,
            distractionFreeMode: true,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/self.jpg" alt="卫恒"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">卫恒</p><p class="is-size-6 is-block">Java Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>HeFei AnHui</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">104</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">16</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">126</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/glmapper" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/glmapper"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="weibo" href="https://weibo.com/u/2412872703"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://juejin.cn/user/3227821827961806" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金社区</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.sofastack.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">SOFAStack</span></span><span class="level-right"><span class="level-item tag">www.sofastack.tech</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#WebServer-自动配置"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">WebServer 自动配置</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ServletWebServerFactoryAutoConfiguration"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">ServletWebServerFactoryAutoConfiguration</span></span></a></li><li><a class="level is-mobile" href="#BeanPostProcessorsRegistrar"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">BeanPostProcessorsRegistrar</span></span></a></li></ul></li><li><a class="level is-mobile" href="#自动配置类中注册的两个-Customizer-Bean"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">自动配置类中注册的两个 Customizer Bean</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#WebServerFactoryCustomizer"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">WebServerFactoryCustomizer</span></span></a></li><li><a class="level is-mobile" href="#TomcatServletWebServerFactoryCustomizer"><span class="level-left"><span class="level-item">1.2.2</span><span class="level-item">TomcatServletWebServerFactoryCustomizer</span></span></a></li></ul></li><li><a class="level is-mobile" href="#WebServerFactory"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">WebServerFactory</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#类体系结构"><span class="level-left"><span class="level-item">1.3.1</span><span class="level-item">类体系结构</span></span></a></li><li><a class="level is-mobile" href="#TomcatServletWebServerFactory"><span class="level-left"><span class="level-item">1.3.2</span><span class="level-item">TomcatServletWebServerFactory</span></span></a></li><li><a class="level is-mobile" href="#准备-Web-App-Context-容器"><span class="level-left"><span class="level-item">1.3.3</span><span class="level-item">准备 Web App Context 容器</span></span></a></li><li><a class="level is-mobile" href="#初始化-TomcatWebServer"><span class="level-left"><span class="level-item">1.3.4</span><span class="level-item">初始化 TomcatWebServer</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Tomcat-启动过程"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">Tomcat 启动过程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#初始化-Server"><span class="level-left"><span class="level-item">1.4.1</span><span class="level-item">初始化 Server</span></span></a></li></ul></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">小结</span></span></a></li></ul><li><a class="level is-mobile" href="#附：Tomcat-组件说明"><span class="level-left"><span class="level-item">2</span><span class="level-item">附：Tomcat 组件说明</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BeanDefinition/"><span class="tag">BeanDefinition</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BeanPostProcessor/"><span class="tag">BeanPostProcessor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BeanWrapper/"><span class="tag">BeanWrapper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CAS/"><span class="tag">CAS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ClassLoader/"><span class="tag">ClassLoader</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CopyOnWriteArraySet/"><span class="tag">CopyOnWriteArraySet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Disruptor/"><span class="tag">Disruptor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Embedded-Tomcat/"><span class="tag">Embedded Tomcat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exception/"><span class="tag">Exception</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Executor/"><span class="tag">Executor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FX-Application/"><span class="tag">FX Application</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FatJar/"><span class="tag">FatJar</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ioc/"><span class="tag">Ioc</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAR/"><span class="tag">JAR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JDK/"><span class="tag">JDK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JUC/"><span class="tag">JUC</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kafka/"><span class="tag">Kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MANIFEST-MF/"><span class="tag">MANIFEST.MF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mockito/"><span class="tag">Mockito</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OOM/"><span class="tag">OOM</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenTracing/"><span class="tag">OpenTracing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PropertySource/"><span class="tag">PropertySource</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Readiness-Check/"><span class="tag">Readiness Check</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ResourceLoader/"><span class="tag">ResourceLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RestTemplate/"><span class="tag">RestTemplate</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RocketMQ/"><span class="tag">RocketMQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SOFA/"><span class="tag">SOFA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SOFAArk/"><span class="tag">SOFAArk</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SOFAStack/"><span class="tag">SOFAStack</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TestDouble/"><span class="tag">TestDouble</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ThreadPoolExecutor/"><span class="tag">ThreadPoolExecutor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tracer/"><span class="tag">Tracer</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zipkin/"><span class="tag">Zipkin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/actuator/"><span class="tag">actuator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aop/"><span class="tag">aop</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/api/"><span class="tag">api</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/apollo/"><span class="tag">apollo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bean-%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6/"><span class="tag">bean 扩展机制</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"><span class="tag">bean 生命周期</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bootstrap/"><span class="tag">bootstrap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cache/"><span class="tag">cache</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">classloader</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/config/"><span class="tag">config</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cookie/"><span class="tag">cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/curator/"><span class="tag">curator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eureka/"><span class="tag">eureka</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/event/"><span class="tag">event</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/feign/"><span class="tag">feign</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gateway/"><span class="tag">gateway</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gc/"><span class="tag">gc</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/github/"><span class="tag">github</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/guava/"><span class="tag">guava</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hystrix/"><span class="tag">hystrix</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/junit/"><span class="tag">junit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jvm/"><span class="tag">jvm</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lock/"><span class="tag">lock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">log</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/logback/"><span class="tag">logback</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/maven/"><span class="tag">maven</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/maven-debug/"><span class="tag">maven debug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/maven-plugin/"><span class="tag">maven plugin</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/merge/"><span class="tag">merge</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/microservices/"><span class="tag">microservices</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mock/"><span class="tag">mock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mybatis/"><span class="tag">mybatis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nacos/"><span class="tag">nacos</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/namespace/"><span class="tag">namespace</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/netflix/"><span class="tag">netflix</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/oop-klass/"><span class="tag">oop-klass</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reactor/"><span class="tag">reactor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rebase/"><span class="tag">rebase</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rpc/"><span class="tag">rpc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/session/"><span class="tag">session</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/set/"><span class="tag">set</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/slf4j/"><span class="tag">slf4j</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-cloud/"><span class="tag">spring cloud</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-mvc/"><span class="tag">spring mvc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6/"><span class="tag">spring 扩展机制</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql/"><span class="tag">sql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/starter-%E6%9C%BA%E5%88%B6/"><span class="tag">starter 机制</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/test/"><span class="tag">test</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread/"><span class="tag">thread</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tomcat/"><span class="tag">tomcat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/top/"><span class="tag">top</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/typecheck/"><span class="tag">typecheck</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yapi/"><span class="tag">yapi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%AD%E5%8F%B0/"><span class="tag">中台</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/"><span class="tag">事件机制</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/"><span class="tag">依赖注入</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/"><span class="tag">分布式链路跟踪</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"><span class="tag">反向代理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E5%B0%84/"><span class="tag">反射</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%88%E8%82%A5/"><span class="tag">合肥</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">并发编程</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="tag">微服务</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%AD%E5%B7%9E/"><span class="tag">杭州</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9E%B6%E6%9E%84/"><span class="tag">架构</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A1%86%E6%9E%B6/"><span class="tag">框架</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%9B%E5%9E%8B/"><span class="tag">泛型</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"><span class="tag">注册中心</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B6%88%E6%81%AF/"><span class="tag">消息</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"><span class="tag">类加载</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"><span class="tag">线程池</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"><span class="tag">自动配置</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><span class="tag">负载均衡</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E7%BB%B4/"><span class="tag">运维</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8/"><span class="tag">迭代器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%85%8D%E7%BD%AE/"><span class="tag">配置</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BB/"><span class="tag">集群选主</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">磊叔的技术博客</a><p class="is-size-7"><span>&copy; 2022 卫恒</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/glmapper"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: false,
                    fold: ''
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>